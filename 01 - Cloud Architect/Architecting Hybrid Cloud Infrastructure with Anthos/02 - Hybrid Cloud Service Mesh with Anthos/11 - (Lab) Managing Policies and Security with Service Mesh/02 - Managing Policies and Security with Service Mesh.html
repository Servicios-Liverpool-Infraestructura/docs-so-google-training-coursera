
<!DOCTYPE html>
<html lang='en'>
<head>
<title>AHYBRID060 Managing Policies and Security with Istio and Citadel | Qwiklabs</title>
<script>
//<![CDATA[
window.gon={};gon.current_user={"firstname":"DANIEL","lastname":"ENRIQUE SANDOVAL SANCHEZ","fullname":"DANIEL ENRIQUE SANDOVAL SANCHEZ","company":"Coursera","email":"desandovals@liverpool.com.mx","origin":"googlecoursera-run, lti-coursera","subscriptions":0,"id":"40414ff5fc280f833d9acca966912f93","qlCreatedAt":"2020-11-17 20:45:59 UTC","optIn":null,"current_organization_id":null,"current_organization_role":null};gon.segment="j4Im8pqIko0Lxq4wVVZWMPMM0EroHUvb";gon.deployment="googlecoursera-run";gon.content={"type":"Lab","id":2075,"name":"AHYBRID060 Managing Policies and Security with Istio and Citadel"};
//]]>
</script>
<script>
  dataLayer = [
    {user: gon.current_user},
    {content: gon.content}
  ];
</script>
<script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer',"GTM-TQR88QK");
</script>
<script>
  EVENT_SOURCE_BASE_URL = "https://googlecoursera-run.qwiklabs.com/nchan-sub?id=";
</script>
<script src="https://cdn.qwiklabs.com/assets/hallofmirrors/polyfills/webcomponents-loader-408088dc333247a761de5f2b2a4ba1cabd2bc36579f83ba92a559eb3682a9b77.js"></script>
<script src="https://cdn.qwiklabs.com/assets/vendor-45d462772c30000424907184f70c7157e95fb6227698d1671c5051818a6f60d8.js"></script>
<script src="https://cdn.qwiklabs.com/assets/application-6874b164d8346f46605fc772a6f7375a39626ffc9f6d168e23a3a8c40bb6fd28.js"></script>
<script src="https://cdn.qwiklabs.com/assets/hallofmirrors/hallofmirrors-b7ff781d00ceebdf75589f58475cea695bafd8d5cc1f3eb4baf6122ed4a4b736.js"></script>
<!--[if lt IE 9]>
<script src='http://html5shim.googlecode.com/svn/trunk/html5.js' type='text/javascript'></script>
<![endif]-->
<!--[endif]>  <![endif]-->
<script type='application/ld+json'>
{
  "@context": "http://schema.org",
  "@type": "WebSite",
  "url": "https://www.qwiklabs.com/",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "https://www.qwiklabs.com/catalog?keywords={search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
</script>
<script id='ze-snippet' src='https://static.zdassets.com/ekr/snippet.js?key=511e4158-0aec-4e3c-b2e6-4daa1769f51e'></script>


<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="nsTqb2Y0DZB3Jz20vFKo6s4ubZqhiLVr6aL0xUf9f/y0oYroZ0LcDuicdwu4bg2E2v5t0U9cOmTQy9RZV+U1vg==" />
<meta content='width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0' name='viewport'>
<meta content='1rRsY0INj8RvwB5EF5pwdxt2A2P9aDgAlsICaJ0d5w0' name='google-site-verification'>
<meta content='#3681E4' property='msapplication-TileColor'>
<meta content='/favicon-144.png' property='msapplication-TileImage'>
<meta content='[{&quot;id&quot;:&quot;recaptcha_experiment&quot;,&quot;optimize_id&quot;:&quot;dpViOcLkT3qS4TvL2mRojA&quot;,&quot;title&quot;:&quot;No Recaptcha shown for trusted users&quot;,&quot;variant_index&quot;:0,&quot;variant&quot;:&quot;original&quot;}]' name='active-experiments'>
<meta content='{&quot;userId&quot;:3894861}' name='help-api-product-data'>
<meta content='Architecting Hybrid Infrastructure with Anthos: Adopt service mesh authentication, and authorization using Istio.' name='description'>
<meta content='Qwiklabs' name='author'>
<meta content='AHYBRID060 Managing Policies and Security with Istio and Citadel | Qwiklabs' property='og:title'>
<meta content='website' property='og:type'>
<meta content='/favicon-144.png' property='og:image'>
<meta content='Qwiklabs' property='og:site_name'>
<meta content='Architecting Hybrid Infrastructure with Anthos: Adopt service mesh authentication, and authorization using Istio.' property='og:description'>
<meta content='/qwiklabs_logo_900x887.png' property='og:logo' size='900x887'>
<meta content='/qwiklabs_logo_994x187.png' property='og:logo' size='994x187'>


<link href='/favicon-32.png' rel='shortcut icon'>
<link color='#3681E4' href='/favicon-svg.svg' rel='mask-icon'>
<link href='/favicon-180.png' rel='apple-touch-icon-precomposed'>



<link rel="stylesheet" media="screen" href="https://fonts.googleapis.com/css?family=Oswald:400|Roboto+Mono:400,700|Roboto:300,400,500,700|Google+Sans:300,400,500,700|Google+Sans+Display:400|Material+Icons|Google+Material+Icons" />


<link rel="stylesheet" media="all" href="https://cdn.qwiklabs.com/assets/application-cf67fd00dd904ecce1e24779d7504aefc7fbd5d00696246fa80212743a81bf07.css" />



</head>
<body class='lab-show l-full no-nav application-new focuses focuses-show lab-show l-full no-nav '>
<noscript>
<iframe height='0' src='https://www.googletagmanager.com/ns.html?id=GTM-TQR88QK' style='display:none;visibility:hidden;' width='0'></iframe>
</noscript>
<span class='hidden' id='flash-sibling-before'></span>

<div class='header-container'>
<div class='header'>
<ql-icon-button class='js-nav-toggle header__nav-panel-button l-mrm'>menu</ql-icon-button>
<div class='header__title'>
<ql-icon-button label="Back" href="https://www.coursera.org/" id="db6423835501e72f" target="_self">arrow_back</ql-icon-button><div class="mdl-tooltip" data-mdl-for="db6423835501e72f">Back</div>

<h1 class='headline-5'>
AHYBRID060 Managing Policies and Security with Istio and Citadel
</h1>
</div>
<div class='header__actions'>
<ql-icon-button class='header__button--search js-header-search-bar-button'>search</ql-icon-button>
<ql-icon-button id='control-panel-target' style='display: none;'>
dashboard
</ql-icon-button>
<ql-menu for='control-panel-target' id='control-panel-menu'></ql-menu>

<ql-icon-button id='help-menu-button'>help</ql-icon-button>
<div class='mdl-tooltip js-tooltip' data-mdl-for='help-menu-button'>
Help
</div>
<ql-menu for='help-menu-button' id='help-menu'>
<ql-menu-item>
<ql-help context='lab' data-analytics-action='opened_help' data-analytics-label='lab' productdata='{&quot;userId&quot;:3894861}'>
Help Center
</ql-help>
</ql-menu-item>
<ql-menu-item>
<a target="_blank" class="ql-body-1" href="https://support.google.com/qwiklabs/contact/contact_us">Email support</a>
</ql-menu-item>
<ql-menu-item>
<a class='ql-body-1' onClick='ql.chat.open()'>Chat support</a>
</ql-menu-item>
</ql-menu>

<ql-icon-button id='language'>language</ql-icon-button>
<div class='mdl-menu mdl-menu__bottom-right mdl-js-menu elevation-3' for='language'>
<a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="ar" href="/focuses/15531179?locale=ar&amp;parent=lti_session">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©‚Ä¨‚Äé
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="de" href="/focuses/15531179?locale=de&amp;parent=lti_session">Deutsch
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="en" href="/focuses/15531179?locale=en&amp;parent=lti_session">English
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="es" href="/focuses/15531179?locale=es&amp;parent=lti_session">espa√±ol (Latinoam√©rica)
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="fr" href="/focuses/15531179?locale=fr&amp;parent=lti_session">fran√ßais
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="id" href="/focuses/15531179?locale=id&amp;parent=lti_session">bahasa Indonesia
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="it" href="/focuses/15531179?locale=it&amp;parent=lti_session">Italiano
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="ja" href="/focuses/15531179?locale=ja&amp;parent=lti_session">Êó•Êú¨Ë™û
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="ko" href="/focuses/15531179?locale=ko&amp;parent=lti_session">ÌïúÍµ≠Ïñ¥
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="pl" href="/focuses/15531179?locale=pl&amp;parent=lti_session">Polski
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="pt_BR" href="/focuses/15531179?locale=pt_BR&amp;parent=lti_session">portugu√™s (Brasil)
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="pt_PT" href="/focuses/15531179?locale=pt_PT&amp;parent=lti_session">portugu√™s (Portugal)
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="ru" href="/focuses/15531179?locale=ru&amp;parent=lti_session">—Ä—É—Å—Å–∫–∏–π
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="tr" href="/focuses/15531179?locale=tr&amp;parent=lti_session">T√ºrk√ße
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="zh" href="/focuses/15531179?locale=zh&amp;parent=lti_session">ÁÆÄ‰Ωì‰∏≠Êñá
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="zh_TW" href="/focuses/15531179?locale=zh_TW&amp;parent=lti_session">ÁπÅÈ´î‰∏≠Êñá
</a></div>
<button class='icon-button' id='my_account'>
<ql-avatar></ql-avatar>
</button>
<ql-menu for='my_account' open>
<div class='my-account-menu'>
<ql-avatar class='l-mtl l-mbl' size='120'></ql-avatar>
<div class='my-account-menu__user-info l-mbl'>
<h4 class='ql-subhead-1'>DANIEL ENRIQUE SANDOVAL SANCHEZ</h4>
<p class='ql-body-2 text--light'>desandovals@liverpool.com.mx</p>
<p class='ql-body-2 text--light'>
</p>
<a class="text--green ql-subhead-2" href="/my_account/payments"><ql-chip positive>
0 Credits
</ql-chip>
</a></div>
<div class='buttons l-mbl'>
<a class="button button--hairline" id="settings" href="/my_account/profile">Settings</a>
</div>
<hr>
<ql-button data-analytics-action='clicked_sign_out' href='/users/sign_out' method='delete'>
Sign Out
</ql-button>
<div class='privacy l-mtl'>
<a class="ql-caption text--light" href="/privacy_policy">Privacy</a>
<span class='ql-caption text--light l-mls l-mrs'>&middot;</span>
<a class="ql-caption text--light" href="/terms_of_service">Terms</a>
</div>
</div>
</ql-menu>

</div>
</div>
<div class='header__search-bar js-header-search-bar'>
<form class="js-search-form-mobile" onsubmit="ql.searchFilter(); return false;" action="/searches/elasticsearch" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="U9Kw6FRI+eMw+lxkhhbdk3G6OVJbkQiJ0fZ3Amj3trF5t9BvVT4ofa9BFtuCKnj9ZWo5GbVFh4bon1eeeO/88w==" />
<input type="text" name="keywords" id="keywords" placeholder="Search" maxlength="255" aria-label="catalog search bar" />
</form>

<ql-icon-button class='js-close-search-bar'>close</ql-icon-button>
</div>
</div>

<nav class='nav-bar'>
<a class="nav-bar__item js-navigation-button" href="/"><ql-icon class='nav-bar__item__icon'>
home
</ql-icon>
<span class='nav-bar__item__label'>
Home
</span>
</a>
<a class="nav-bar__item js-navigation-button" href="/catalog"><ql-icon class='nav-bar__item__icon'>
school
</ql-icon>
<span class='nav-bar__item__label'>
Catalog
</span>
</a>
<a class="nav-bar__item js-navigation-button" href="/my_learning"><ql-icon class='nav-bar__item__icon'>
event_note
</ql-icon>
<span class='nav-bar__item__label'>
My Learning
</span>
</a>
</nav>

<nav class='nav-panel js-nav-panel'>
<div class='nav-panel__logo'>
<div class='logo logo--blue'></div>
</div>
<a title="Home" tabindex="-1" class="nav-panel__item js-navigation-button" href="/"><ql-icon class='nav-panel__item__icon'>
home
</ql-icon>
<div class='nav-panel__item__label'>
Home
</div>
</a>
<a title="Catalog" tabindex="-1" class="nav-panel__item js-navigation-button" href="/catalog"><ql-icon class='nav-panel__item__icon'>
school
</ql-icon>
<div class='nav-panel__item__label'>
Catalog
</div>
</a>
<a title="My Learning" tabindex="-1" class="nav-panel__item js-navigation-button" href="/my_learning"><ql-icon class='nav-panel__item__icon'>
event_note
</ql-icon>
<div class='nav-panel__item__label'>
My Learning
</div>
</a>
<div class='nav-panel__spacer'></div>
<a title="Profile" tabindex="-1" class="nav-panel__item js-navigation-button" href="/my_account/profile"><ql-icon class='nav-panel__item__icon'>
account_circle
</ql-icon>
<div class='nav-panel__item__label'>
Profile
</div>
</a>
<a title="Credits &amp; Subscriptions" tabindex="-1" class="nav-panel__item js-navigation-button" href="/my_account/credits"><ql-icon class='nav-panel__item__icon'>
money
</ql-icon>
<div class='nav-panel__item__label'>
Credits &amp; Subscriptions
</div>
</a>
<a title="Security" tabindex="-1" class="nav-panel__item js-navigation-button" href="/my_account/security"><ql-icon class='nav-panel__item__icon'>
security
</ql-icon>
<div class='nav-panel__item__label'>
Security
</div>
</a>
<div class='nav-panel__spacer'></div>
<a class="nav-panel__item" tabindex="-1" href="#"><ql-help>
<div class='nav-panel__help-item'>
<ql-icon class='nav-panel__item__icon'>help</ql-icon>
<div class='nav-panel__item__label'>
Help
</div>
</div>
</ql-help>
</a><div class='nav-panel__small-links'>
<a tabindex="-1" href="/privacy_policy">Privacy</a>
<a tabindex="-1" href="/terms_of_service">Terms</a>
</div>
</nav>
<div class='nav-panel__overlay js-nav-toggle'></div>

<main class='js-main'>
<div class='l-main-wrapper' id='main-wrapper'>







<ql-drawer-container class='js-lab-state' data-analytics-payload='{&quot;label&quot;:&quot;AHYBRID060 Managing Policies and Security with Istio and Citadel&quot;,&quot;lab_name&quot;:&quot;AHYBRID060 Managing Policies and Security with Istio and Citadel&quot;,&quot;classroom_name&quot;:null,&quot;deployment&quot;:&quot;googlecoursera-run&quot;}' data-focus-id='15531179' data-lab-billing-limit='0.0' data-lab-duration='86400' data-parent='lti_session' data-recaptcha-enabled id='lab-container'>
<ql-drawer id='terminal-drawer' slot='drawer' style='width: calc(100% - 480px)'>
<iframe allow='clipboard-read' class='terminal' id='embedded-resource'></iframe>
</ql-drawer>
<ql-drawer-content class='js-lab-wrapper' id='lab-content' slot='drawer-content'>
<ql-drawer-container id='lab-content-container'>
<ql-drawer id='control-panel-drawer' open slot='drawer' width='320'>
<ql-lab-control-panel class='ql-lab-control-panel__max-height control-panel js-lab-control-panel' connectionFiles='[]' labControlButton='{&quot;disabled&quot;:false,&quot;pending&quot;:false,&quot;running&quot;:false}' labDetails='[]' labTimer='{&quot;ticking&quot;:false,&quot;secondsRemaining&quot;:86400}' studentResources='[]'>
<script src="https://www.recaptcha.net/recaptcha/api.js?render=6LeVI8IUAAAAAJNdox5eTkYrw9SbvhZ1TFyv3iHr"   ></script>
        <script>
          // Define function so that we can call it again later if we need to reset it
          // This executes reCAPTCHA and then calls our callback.
          function executeRecaptchaForStartLab() {
            grecaptcha.ready(function() {
              grecaptcha.execute('6LeVI8IUAAAAAJNdox5eTkYrw9SbvhZ1TFyv3iHr', {action: 'start_lab'}).then(function(token) {
                setInputWithRecaptchaResponseTokenForStartLab('g-recaptcha-response-data-start-lab', token)
              });
            });
          };
          // Invoke immediately
          executeRecaptchaForStartLab()

          // Async variant so you can await this function from another async function (no need for
          // an explicit callback function then!)
          // Returns a Promise that resolves with the response token.
          async function executeRecaptchaForStartLabAsync() {
            return new Promise((resolve, reject) => {
              grecaptcha.ready(async function() {
                resolve(await grecaptcha.execute('6LeVI8IUAAAAAJNdox5eTkYrw9SbvhZ1TFyv3iHr', {action: 'start_lab'}))
              });
            })
          };

                    var setInputWithRecaptchaResponseTokenForStartLab = function(id, token) {
            var element = document.getElementById(id);
            element.value = token;
          }

        </script>
<input type="hidden" name="g-recaptcha-response-data[start_lab]" id="g-recaptcha-response-data-start-lab" data-sitekey="6LeVI8IUAAAAAJNdox5eTkYrw9SbvhZ1TFyv3iHr" class="g-recaptcha g-recaptcha-response "/>

<div class='hidden' id='recaptcha-v2-start-lab' slot='recaptcha'>
<script src="https://www.recaptcha.net/recaptcha/api.js" async defer ></script>
<div data-sitekey="6LeOI8IUAAAAAPkHlMAE9NReCD_1WD81iYlBlCnV" data-callback="recaptchaComplete" data-expired-callback="expireV2Token" class="g-recaptcha "></div>
          <noscript>
            <div>
              <div style="width: 302px; height: 422px; position: relative;">
                <div style="width: 302px; height: 422px; position: absolute;">
                  <iframe
                    src="https://www.recaptcha.net/recaptcha/api/fallback?k=6LeOI8IUAAAAAPkHlMAE9NReCD_1WD81iYlBlCnV"
                    name="ReCAPTCHA"
                    style="width: 302px; height: 422px; border-style: none; border: 0; overflow: hidden;">
                  </iframe>
                </div>
              </div>
              <div style="width: 300px; height: 60px; border-style: none;
                bottom: 12px; left: 25px; margin: 0px; padding: 0px; right: 25px;
                background: #f9f9f9; border: 1px solid #c1c1c1; border-radius: 3px;">
                <textarea id="g-recaptcha-response" name="g-recaptcha-response"
                  class="g-recaptcha-response"
                  style="width: 250px; height: 40px; border: 1px solid #c1c1c1;
                  margin: 10px 25px; padding: 0px; resize: none;">
                </textarea>
              </div>
            </div>
          </noscript>

</div>
</ql-lab-control-panel>
</ql-drawer>
<ql-drawer-content id='lab-instructions' slot='drawer-content'>
<div class='alert alert--fake js-alert'>
<p class='alert__message js-alert-message'></p>
<a class='alert__close js-alert-close'>
<i class='fa fa-times'></i>
</a>
<iframe class='l-ie-iframe-fix'></iframe>
</div>
<div class='js-lab-content lab-content__renderable-instructions'>
<div class='lab-preamble'>
<h1 class='lab-preamble__title'>
AHYBRID060 Managing Policies and Security with Istio and Citadel
</h1>
<div class='lab-preamble__details subtitle-headline-1'>
<span>24 hours </span>
<span>Free</span>
<div class='lab__rating'>
<a href="/focuses/15531179/reviews?parent=lti_session"><div class='rateit' data-rateit-readonly='true' data-rateit-value='4.3776'></div>

</a><a data-target='#lab-review-modal' data-toggle='modal'>
Rate Lab
</a>
</div>
</div>
</div>

<div class='js-markdown-instructions markdown-lab-instructions' id='markdown-lab-instructions'>



<h2 id="step1">Overview</h2>
<h3>Objectives</h3>
<p>In this lab, you learn how to perform the following tasks:</p>
<ul>
<li>
<p>Install Anthos Service Mesh in your GKE cluster</p>
</li>
<li>
<p>Deploy the <strong>sleep</strong> client and the <strong>httpbin</strong> server to test mTLS connectivity</p>
</li>
<li>
<p>Learn Istio auto mutual TLS, which comes in PERMISSIVE mode to receive plaintext and mTLS traffic</p>
</li>
<li>
<p>Enforce STRICT mTLS mode across the service mesh</p>
</li>
<li>
<p>Enforce STRICT mTLS mode on a single namespace</p>
</li>
<li>
<p>Explore the security configurations in the Anthos Service Mesh Dashboard</p>
</li>
<li>
<p>Add authorization policies to enforce access based on a JSON Web Token (JWT)</p>
</li>
<li>
<p>Add authorization policies for HTTP traffic in an Istio mesh</p>
</li>
</ul>
<h2 id="step2">Task 0. Lab Setup</h2>
<p>In this task, you use Qwiklabs and perform initialization steps for your lab.</p>
<h3>Access Qwiklabs</h3>
<p>For each lab, you get a new GCP project and set of resources for a fixed time at no cost.</p>
<ol>
<li>
<p>Make sure you signed into Qwiklabs using an <strong>incognito window</strong>.</p>
</li>
<li>
<p>Note the lab's access time (for example, <img alt="img/time.png" src="https://cdn.qwiklabs.com/aZQJ4BT7uCmM9XR6BTXgTRP1Hfu1T7q6V%2BcnbdEsbpU%3D"> and make sure you can finish in that time block.</p>
</li>
</ol>
<aside> <p>
  There is no pause feature. You can restart if needed, but you have to start at the beginning.
  </p>

</aside>
<ol start="3">
<li>
<p>When ready, click <img alt="img/start_lab.png" src="https://cdn.qwiklabs.com/XE8x7uvQokyubNwnYKKc%2BvBBNrMlo5iNZiDDzQQ3Ddo%3D">.</p>
</li>
<li>
<p>Note your lab credentials. You will use them to sign in to Cloud Platform Console.
<img alt="img/open_google_console.png" src="https://cdn.qwiklabs.com/0d78dhX6IVMVWmixCPPSBbmi5O2GPokCXf1Ps1AkTgI%3D"></p>
</li>
<li>
<p>Click <strong>Open Google Console</strong>.</p>
</li>
<li>
<p>Click <strong>Use another account</strong> and copy/paste credentials for <strong>this</strong> lab into the prompts.</p>
</li>
</ol>
<aside class="warning"><p>
  If you use other credentials, you'll get errors or <strong>incur charges</strong>.
  </p>
</aside>
<ol start="7">
<li>Accept the terms and skip the recovery resource page.</li>
</ol>
<aside class="warning"><p>
  Do not click <strong>End Lab</strong> unless you are finished with the lab or want to restart it. This clears your work and removes the project.
  </p>
</aside>

<p>After you complete the initial sign-in steps, the project dashboard appears.</p>
<p><img alt="GCP Project Dashboard" src="https://cdn.qwiklabs.com/dxfeoOcn1ObyC0BYyoqqqSi4rO%2FeMdbWPFjoK6C0YYk%3D"></p>
<p>Click <strong>Select a project</strong>, highlight your <em>GCP Project ID</em>, and click
<strong>OPEN</strong> to select your project.</p>
<h3>Activate Google Cloud Shell</h3>
<p>Google Cloud Shell is a virtual machine that is loaded with development tools. It offers a persistent 5GB home directory and runs on the Google Cloud.
Google Cloud Shell provides command-line access to your GCP resources.</p>
<ol>
<li>
<p>In GCP console, on the top right toolbar, click the Open Cloud Shell button.</p>
<p><img alt="Cloud Shell icon" src="https://cdn.qwiklabs.com/vdY5e%2Fan9ZGXw5a%2FZMb1agpXhRGozsOadHURcR8thAQ%3D"></p>
</li>
<li>
<p>Click <strong>Continue</strong>.
<img alt="cloudshell_continue.png" src="https://cdn.qwiklabs.com/lr3PBRjWIrJ%2BMQnE8kCkOnRQQVgJnWSg4UWk16f0s%2FA%3D"></p>
</li>
</ol>
<p>It takes a few moments to provision and connect to the environment. When you are connected, you are already authenticated, and the project is set to your <em>PROJECT_ID</em>. For example:</p>
<p><img alt="Cloud Shell Terminal" src="https://cdn.qwiklabs.com/hmMK0W41Txk%2B20bQyuDP9g60vCdBajIS%2B52iI2f4bYk%3D"></p>
<p><strong>gcloud</strong> is the command-line tool for Google Cloud Platform. It comes pre-installed on Cloud Shell and supports tab-completion.</p>
<p>You can list the active account name with this command:</p>
<pre><code>gcloud auth list&#x000A;</code></pre>
<p>Output:</p>
<pre><code class="language-output prettyprint">Credentialed accounts:&#x000A; - &lt;myaccount&gt;@&lt;mydomain&gt;.com (active)&#x000A;</code></pre>
<p>Example output:</p>
<pre><code class="language-Output prettyprint">Credentialed accounts:&#x000A; - google1623327_student@qwiklabs.net&#x000A;</code></pre>
<p>You can list the project ID with this command:</p>
<pre><code>gcloud config list project&#x000A;</code></pre>
<p>Output:</p>
<pre><code class="language-output prettyprint">[core]&#x000A;project = &lt;project_ID&gt;&#x000A;</code></pre>
<p>Example output:</p>
<pre><code class="language-Output prettyprint">[core]&#x000A;project = qwiklabs-gcp-44776a13dea667a6&#x000A;</code></pre>
<ql-infobox>
  Full documentation of <strong>gcloud</strong> is available on
  <a href="https://cloud.google.com/sdk/gcloud" target="_blank">
    Google Cloud gcloud Overview
  </a>.
</ql-infobox>

<h2 id="step3">Task 1. Confirm Anthos Service Mesh setup</h2>
<p>This lab environment has already been partially configured. A GKE cluster with
2 nodes have been provisioned for you. If you would like to investigate how the
cluster creation process happened, look at the <strong>setup-vm</strong> startup-script.</p>
<h3>Configure cluster access for kubectl</h3>
<ol>
<li>
<p>Set environment variables for the zone and cluster name:</p>
<pre><code class="language-bash prettyprint">export CLUSTER_NAME=gke&#x000A;export CLUSTER_ZONE=us-central1-b&#x000A;</code></pre>
</li>
<li>
<p>In Cloud Shell, configure <strong>kubectl</strong> command line access by running:</p>
<pre><code class="language-bash prettyprint"># get the project id&#x000A;export GCLOUD_PROJECT=$(gcloud config get-value project)&#x000A;&#x000A;# configure kubectl&#x000A;gcloud container clusters get-credentials $CLUSTER_NAME \&#x000A;    --zone $CLUSTER_ZONE --project $GCLOUD_PROJECT&#x000A;</code></pre>
</li>
</ol>
<h3>Verify cluster and Anthos Service Mesh installation</h3>
<ol start="3">
<li>
<p>Check that your cluster is up and running:</p>
<pre><code class="language-bash prettyprint">gcloud container clusters list&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code>NAME     LOCATION       MASTER_VERSION  ... STATUS&#x000A;central  us-central1-b  1.15.12-gke.2   ... RUNNING&#x000A;</code></pre>
</li>
<li>
<p>Ensure the following Kubernetes services are deployed:
<strong>istio-ingressgateway</strong>, <strong>istiod</strong>, <strong>promsd</strong>:</p>
<pre><code class="language-bash prettyprint">kubectl get service -n istio-system&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code>NAME                      TYPE             CLUSTER-IP&#x000A;istio-ingressgateway      LoadBalancer     10.7.249.134&#x000A;istiod                    ClusterIP        10.7.249.95&#x000A;promsd                    ClusterIP        10.7.249.69&#x000A;</code></pre>
</li>
<li>
<p>Ensure the corresponding Kubernetes pods are deployed and all containers
are up and running: <strong>istio-ingressgateway-*</strong>,
<strong>istiod-*</strong>, and <strong>promsd-*</strong>:</p>
<pre><code class="language-bash prettyprint">kubectl get pods -n istio-system&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code>NAME                                      READY   STATUS&#x000A;istio-ingressgateway-845f4d4b6c-hg7gz     1/1     Running&#x000A;...&#x000A;</code></pre>
</li>
</ol>
<h2 id="step4">Task 2. Deploy sleep and httpbin services</h2>
<p>In this task, you create a set of namespaces to host the
<a href="https://github.com/istio/istio/tree/release-1.6/samples/httpbin" target="_blank">httpbin</a>,
and <a href="https://github.com/istio/istio/tree/release-1.6/samples/sleep" target="_blank">sleep</a>
services. You will use those services to explore the impact of mTLS on
traffic them. The <strong>sleep</strong> service acts as the client and will call the
<strong>httpbin</strong> service, which acts as a server.</p>
<h3>Setup the Authentication Example</h3>
<p>You will deploy this example configuration and then use it to explore the
authentication options that Istio offers:</p>
<p><img alt="mTLS Istio Permissive" src="https://cdn.qwiklabs.com/jYbq9lGg6Fsl6SNQ6tCQCuxqEPWmpbmja6g6ziatX1o%3D"></p>
<ol>
<li>
<p>In Cloud Shell, create namespaces for the example clients and services.
Traffic in the <strong>legacy-</strong>* namespaces takes place over plain text, while
traffic in the <strong>mtls-</strong>* namespaces happens over mTLS:</p>
<pre><code class="language-bash prettyprint">kubectl create ns mtls-client&#x000A;kubectl create ns mtls-service&#x000A;kubectl create ns legacy-client&#x000A;kubectl create ns legacy-service&#x000A;&#x000A;kubectl get namespaces&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code>NAME              STATUS   AGE&#x000A;...&#x000A;legacy-client     Active   5m50s&#x000A;legacy-service    Active   5m34s&#x000A;mtls-client       Active   5m56s&#x000A;mtls-service      Active   5m40s&#x000A;</code></pre>
</li>
<li>
<p>Deploy the legacy services in the <strong>legacy-</strong>* namespaces:</p>
<pre><code class="language-bash prettyprint">#configurations are stored in Github&#x000A;&#x000A;kubectl apply -f \&#x000A;https://raw.githubusercontent.com/istio/istio/release-1.6/samples/sleep/sleep.yaml \&#x000A;-n legacy-client&#x000A;&#x000A;kubectl apply -f \&#x000A;https://raw.githubusercontent.com/istio/istio/release-1.6/samples/httpbin/httpbin.yaml \&#x000A;-n legacy-service&#x000A;</code></pre>
</li>
<li>
<p>Enable auto-injection of the Istio sidecar proxy on the <strong>mtls-</strong>* namespaces:</p>
<pre><code class="language-bash prettyprint"># get the revision label&#x000A;export DEPLOYMENT=$(kubectl get deployments -n istio-system | grep istiod)&#x000A;export VERSION=asm-$(echo $DEPLOYMENT | cut -d'-' -f 3)-$(echo $DEPLOYMENT \&#x000A;    | cut -d'-' -f 4 | cut -d' ' -f 1)&#x000A;&#x000A;# enable auto-injection on the namespaces&#x000A;kubectl label namespace mtls-client istio-injection- istio.io/rev=${VERSION} --overwrite&#x000A;kubectl label namespace mtls-service istio-injection- istio.io/rev=${VERSION} --overwrite&#x000A;</code></pre>
</li>
<li>
<p>Deploy the services in the <strong>mtls-</strong>* namespaces:</p>
<pre><code class="language-bash prettyprint">kubectl apply -f \&#x000A;https://raw.githubusercontent.com/istio/istio/release-1.6/samples/sleep/sleep.yaml \&#x000A;-n mtls-client&#x000A;&#x000A;kubectl apply -f \&#x000A;https://raw.githubusercontent.com/istio/istio/release-1.6/samples/httpbin/httpbin.yaml \&#x000A;-n mtls-service&#x000A;</code></pre>
</li>
<li>
<p>Verify that the <strong>sleep</strong> service and the <strong>httpbin</strong> service are each deployed
in both the <strong>mtls-service</strong> and <strong>legacy-service</strong> namespaces:</p>
<pre><code class="language-bash prettyprint">kubectl get services --all-namespaces&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code>NAMESPACE        NAME                        TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)                                                      AGE&#x000A;...&#x000A;legacy-client    sleep                       ClusterIP      10.7.248.186   &lt;none&gt;        80/TCP                                                       31s&#x000A;legacy-service   httpbin                     ClusterIP      10.7.248.121   &lt;none&gt;        8000/TCP                                                     14s&#x000A;mtls-client      sleep                       ClusterIP      10.7.252.127   &lt;none&gt;        80/TCP                                                       99s&#x000A;mtls-service     httpbin                     ClusterIP      10.7.247.200   &lt;none&gt;        8000/TCP                                                     50s&#x000A;</code></pre>
</li>
<li>
<p>Verify that a <strong>sleep</strong> pod is running in the <strong>mtls-client</strong> and
<strong>legacy-client</strong> namespaces and that an <strong>httpbin</strong> pod is running in the
<strong>mtls-service</strong> and <strong>legacy-service</strong> namespaces:</p>
<pre><code class="language-bash prettyprint">kubectl get pods --all-namespaces&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code>NAMESPACE        NAME                                                       READY   STATUS    RESTARTS   AGE&#x000A;...&#x000A;legacy-client    sleep-f8cbf5b76-5v8f9                                      1/1     Running   0          65s&#x000A;legacy-service   httpbin-779c54bf49-5fr9k                                   1/1     Running   0          47s&#x000A;mtls-client      sleep-64d4546bdb-gnpc5                                     2/2     Running   0          2m13s&#x000A;mtls-service     httpbin-5d7bdc9d78-7mfn5                                   2/2     Running   0          84s&#x000A;</code></pre>
</li>
</ol>
<h3>Verify that the two sleep clients can communicate with the two httpbin services</h3>
<ol start="7">
<li>
<p>Use Cloud Shell to run this nested command loop:</p>
<pre><code class="language-bash prettyprint">for from in "mtls-client" "legacy-client"; do&#x000A;  for to in "mtls-service" "legacy-service"; do&#x000A;    kubectl exec $(kubectl get pod -l app=sleep -n ${from} -o jsonpath={.items..metadata.name}) -c sleep -n ${from} -- curl "http://httpbin.${to}:8000/ip" -s -o /dev/null -w "sleep.${from} to httpbin.${to}: %{http_code}\n"&#x000A;  done&#x000A;done&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code>sleep.mtls-client to httpbin.mtls-service: 200&#x000A;sleep.mtls-client to httpbin.legacy-service: 200&#x000A;sleep.legacy-client to httpbin.mtls-service: 200&#x000A;sleep.legacy-client to httpbin.legacy-service: 200&#x000A;</code></pre>
</li>
</ol>
<p>Now we're ready to enforce security policies for this application.</p>
<h2 id="step5">Task 3. Understand authentication and enable service to service authentication with mTLS</h2>
<h3>Anthos Service Mesh</h3>
<ol>
<li>
<p>In the console, go the <strong>Navigation &gt; Anthos &gt; Service Mesh</strong>.</p>
</li>
<li>
<p>In Anthos Service Mesh dashboard, you will see the 4 services that we just
created. Click on the <strong>httpbin</strong> service located in the <strong>mtls-service</strong>
namespace.</p>
</li>
<li>
<p>In the left side panel, go to <strong>Connected Services</strong>.</p>
</li>
<li>
<p>Use your mouse to hover over the lock symbol in the <strong>Request port</strong> column.
It will show you that the traffic is a mix of mTLS and plaintext. That's
because both sleep services are sending traffic to <strong>httpbin</strong>. Remember that
the <strong>sleep</strong> service with the Istio sidecar is located in the
<strong>mtls-client</strong> namespace and the other <strong>sleep</strong> service without Istio is
located in the <strong>legacy-client</strong> namespace.</p>
</li>
</ol>
<p><img alt="ASM Connected Services" src="https://cdn.qwiklabs.com/YWZDfBppOcz9OrtPKManxJ1eG4SOoiAi3AntPPg6WEM%3D"></p>
<ol start="5">
<li>Now check out the <strong>Security (Beta)</strong> tab in the left side panel. It shows
you that the <strong>httbin</strong> service has received both plaintext and mTLS traffic</li>
</ol>
<p><img alt="ASM Security (Beta)" src="https://cdn.qwiklabs.com/TInjRw4HXhE7GayISVmojGvH6B5ZibQEqbD2dz9gmYg%3D"></p>
<h3>Test Auto mutual TLS</h3>
<p>By default, Istio configures destination workloads in <code>PERMISSIVE</code> mode. When
<code>PERMISSIVE</code> mode is enabled a service can accept both plaintext and mTLS
traffic. mTLS is used when the request contains the <strong>X-Forwarded-Client-Cert</strong>
header.</p>
<ol start="6">
<li>
<p>Use the Cloud Shell to send a request from the <strong>sleep</strong> service in the
<strong>mtls-client</strong> namespace to the <strong>httpbin</strong> service in the <strong>mtls-service</strong>
namespace:</p>
<pre><code class="language-bash prettyprint">kubectl exec $(kubectl get pod -l app=sleep -n mtls-client -o jsonpath={.items..metadata.name}) -c sleep -n mtls-client -- curl http://httpbin.mtls-service:8000/headers -s | grep X-Forwarded-Client-Cert&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code>"X-Forwarded-Client-Cert": "By=spiffe:// ...&#x000A;</code></pre>
<p>The traffic included the <strong>X-Forwarded-Client-Cert</strong> header and therefore was mutually authenticated and encrypted</p>
</li>
<li>
<p>Now send a request from the <strong>sleep</strong> service in the <strong>mtls-client</strong>
namespace to the <strong>httpbin</strong> service in the <strong>legacy-service</strong> namespace:</p>
<pre><code class="language-bash prettyprint">kubectl exec $(kubectl get pod -l app=sleep -n mtls-client -o jsonpath={.items..metadata.name}) -c sleep -n mtls-client -- curl http://httpbin.legacy-service:8000/headers -s | grep X-Forwarded-Client-Cert&#x000A;</code></pre>
<p>The <strong>X-Forwarded-Client-Cert</strong> header isn't present so the traffic was
sent and received in plaintext</p>
</li>
<li>
<p>Finally, send a request from the <strong>sleep</strong> service in the <strong>legacy-client</strong>
namespace to the <strong>httpbin</strong> service in the <strong>mtls-service</strong> namespace:</p>
<pre><code class="language-bash prettyprint">kubectl exec $(kubectl get pod -l app=sleep -n legacy-client -o jsonpath={.items..metadata.name}) -c sleep -n legacy-client -- curl http://httpbin.mtls-service:8000/headers -s | grep X-Forwarded-Client-Cert&#x000A;</code></pre>
<p>The <strong>X-Forwarded-Client-Cert</strong> header isn't present so the traffic was sent
and received in plaintext</p>
</li>
</ol>
<p>üîé Note: the <strong>httpbin</strong> service in the <strong>mtls-service</strong> namespace accepted
mTLS traffic from the <strong>sleep</strong> service in the <strong>mtls-client</strong> namespace <em>and</em>
plaintext from the <strong>sleep</strong> service in the <strong>legacy-client</strong> namespace.</p>
<h3>Enforce STRICT mTLS mode across the service mesh</h3>
<p>In <code>STRICT</code> mode, services injected with the Istio proxy will not accept
plaintext traffic and will mutually authenticate with their clients.</p>
<p>You can enforce <code>STRICT</code> mTLS mode across the whole mesh or on a per-namespace
basis by creating PeerAuthentication resources.</p>
<p><img alt="mTLS Istio STRICT" src="https://cdn.qwiklabs.com/2o%2BACwB%2F9BVdlT6KBnCNXYHfPcrly%2FVwlJ%2BRywYPKsk%3D"></p>
<ol start="9">
<li>
<p>Create a Peer Authentication resource for the entire Service Mesh:</p>
<pre><code class="language-bash prettyprint">kubectl apply -n istio-system -f - &lt;&lt;EOF&#x000A;apiVersion: "security.istio.io/v1beta1"&#x000A;kind: "PeerAuthentication"&#x000A;metadata:&#x000A;  name: "mesh-wide-mtls"&#x000A;spec:&#x000A;  mtls:&#x000A;    mode: STRICT&#x000A;EOF&#x000A;</code></pre>
</li>
<li>
<p>Run this nested command loop:</p>
<pre><code class="language-bash prettyprint">for from in "mtls-client" "legacy-client"; do&#x000A;  for to in "mtls-service" "legacy-service"; do&#x000A;    kubectl exec $(kubectl get pod -l app=sleep -n ${from} -o jsonpath={.items..metadata.name}) -c sleep -n ${from} -- curl "http://httpbin.${to}:8000/ip" -s -o /dev/null -w "sleep.${from} to httpbin.${to}: %{http_code}\n"&#x000A;  done&#x000A;done&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code>sleep.mtls-client to httpbin.mtls-service: 200&#x000A;sleep.mtls-client to httpbin.legacy-service: 200&#x000A;sleep.legacy-client to httpbin.mtls-service: 000&#x000A;command terminated with exit code 56&#x000A;sleep.legacy-client to httpbin.legacy-service: 200&#x000A;</code></pre>
<p>üîé The <strong>httpbin</strong> service in the <strong>mtls-service</strong> namespace now rejects the
plaintext traffic it receives from the <strong>sleep</strong> client in the
<strong>legacy-client</strong> namespace.</p>
</li>
<li>
<p>Remove the mesh wide mTLS PeerAuthentication resource by running this
command in Cloud Shell:</p>
<pre><code class="language-bash prettyprint">kubectl delete pa mesh-wide-mtls -n istio-system&#x000A;</code></pre>
</li>
</ol>
<h3>Enforce STRICT mTLS mode on a single namespace</h3>
<ol start="12">
<li>
<p>In Cloud Shell create a namespace for <code>STRICT</code> mTLS:</p>
<pre><code class="language-bash prettyprint">kubectl create ns strict-mtls-service&#x000A;</code></pre>
</li>
<li>
<p>Enable auto-injection of the Istio sidecar proxy on the new namespace:</p>
<pre><code class="language-bash prettyprint"># get the revision label&#x000A;export DEPLOYMENT=$(kubectl get deployments -n istio-system | grep istiod)&#x000A;export VERSION=asm-$(echo $DEPLOYMENT | cut -d'-' -f 3)-$(echo $DEPLOYMENT \&#x000A;    | cut -d'-' -f 4 | cut -d' ' -f 1)&#x000A;&#x000A;# enable auto-injection on the namespaces&#x000A;kubectl label namespace strict-mtls-service istio-injection- istio.io/rev=${VERSION} --overwrite&#x000A;</code></pre>
</li>
<li>
<p>Use Cloud Shell to deploy another instance of the httpbin service in
the <strong>strict-mtls-service</strong> namespace:</p>
<pre><code class="language-bash prettyprint">kubectl apply -f \&#x000A;https://raw.githubusercontent.com/istio/istio/release-1.6/samples/httpbin/httpbin.yaml \&#x000A;-n strict-mtls-service&#x000A;</code></pre>
</li>
<li>
<p>Create a PeerAuthentication resource for the <strong>strict-mtls-service</strong>
namespace:</p>
<pre><code class="language-bash prettyprint">kubectl apply -n strict-mtls-service -f - &lt;&lt;EOF&#x000A;apiVersion: "security.istio.io/v1beta1"&#x000A;kind: "PeerAuthentication"&#x000A;metadata:&#x000A;  name: "restricted-mtls"&#x000A;  namespace: strict-mtls-service&#x000A;spec:&#x000A;  mtls:&#x000A;    mode: STRICT&#x000A;EOF&#x000A;</code></pre>
</li>
<li>
<p>Verify that the <strong>httpbin</strong> service in the <strong>mtls-service</strong> namespace still
accepts plaintext traffic:</p>
<pre><code class="language-bash prettyprint">kubectl exec $(kubectl get pod -l app=sleep -n legacy-client -o jsonpath={.items..metadata.name}) -c sleep -n legacy-client -- curl "http://httpbin.mtls-service:8000/ip" -s -o /dev/null -w "sleep.legacy-client to httpbin.mtls-service: %{http_code}\n"&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code>sleep.legacy-client to httpbin.mtls-service: 200&#x000A;</code></pre>
</li>
<li>
<p>Now check to see that the <strong>strict-mtls-service</strong> namespace <strong>httpbin</strong>
service does not accept plaintext traffic:</p>
<pre><code class="language-bash prettyprint">kubectl exec $(kubectl get pod -l app=sleep -n legacy-client -o jsonpath={.items..metadata.name}) -c sleep -n legacy-client -- curl "http://httpbin.strict-mtls-service:8000/ip" -s -o /dev/null -w "sleep.legacy-client to httpbin.strict-mtls-service: %{http_code}\n"&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code>sleep.legacy-client to httpbin.strict-mtls-service: 000&#x000A;command terminated with exit code 7&#x000A;</code></pre>
</li>
<li>
<p>Verify that the <strong>httpbin</strong> service in the <strong>strict-mtls-service</strong> namespace
does accept mTLS traffic:</p>
<pre><code class="language-bash prettyprint">kubectl exec $(kubectl get pod -l app=sleep -n mtls-client -o jsonpath={.items..metadata.name}) -c sleep -n mtls-client -- curl "http://httpbin.strict-mtls-service:8000/ip" -s -o /dev/null -w "sleep.mtls-client to httpbin.strict-mtls-service: %{http_code}\n"&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code>sleep.mtls-client to httpbin.strict-mtls-service: 200&#x000A;</code></pre>
</li>
<li>
<p>In the Google Cloud console, select <strong>Navigation &gt; Anthos &gt; Service Mesh</strong>.</p>
</li>
<li>
<p>In Anthos Service Mesh dashboard, you will see that we have 5 services now.
Click on the <strong>httpbin</strong> service in the <strong>strict-mtls-service</strong> namespace.</p>
</li>
<li>
<p>In the left side panel, click on <strong>Connected Services</strong>.</p>
</li>
<li>
<p>Use your mouse to hover over the lock symbol in the <strong>Request Port</strong> column
to see that only <strong>mTLS</strong> traffic has been received.</p>
</li>
</ol>
<p><img alt="ASM Connected Services STRICT mode" src="https://cdn.qwiklabs.com/IysXg%2F%2FT2pS2lKp7R3A5t18HYKnfJDrefrwnL5Y2K6I%3D"></p>
<ol start="22">
<li>Now check out the <strong>Security (Beta)</strong> tab in the left side panel. Again only
<strong>mTLS</strong> traffic has been received.</li>
</ol>
<p><img alt="ASM Connected Services STRICT mode" src="https://cdn.qwiklabs.com/nvBcjkKfm981WfcohmI6s%2Fjoz86Wehkl7i%2FpKWugzJ0%3D"></p>
<ol start="23">
<li>
<p>Remove the <strong>strict-mtls-service</strong> peer authentication policy by running
this command in Cloud Shell:</p>
<pre><code class="language-bash prettyprint">kubectl delete pa restricted-mtls -n strict-mtls-service&#x000A;</code></pre>
</li>
</ol>
<h2 id="step6">Task 4. Leverage RequestAuthentication and AuthorizationPolicy resources</h2>
<p>This task shows you how to set up and use RequestAuthentication and
AuthorizationPolicy resources. Ultimately, you will allow requests that
have an approved JWT, and deny requests that don't.</p>
<h3>RequestAuthentication</h3>
<p>A RequestAuthentication resource defines the request authentication methods
that are supported by a workload. Requests with invalid authentication
information will be rejected. Requests with no authentication credentials will
be accepted but will not have any authenticated identity.</p>
<ol>
<li>
<p>Create a RequestAuthentication resource for the <code>httpbin</code> workload in the
<code>mtls-service</code> namespace. This policy allows the workload to accept requests
with a JWT issued by <code>testing@secure.istio.io</code>:</p>
<pre><code class="language-bash prettyprint">kubectl apply -f - &lt;&lt;EOF&#x000A;apiVersion: "security.istio.io/v1beta1"&#x000A;kind: "RequestAuthentication"&#x000A;metadata:&#x000A;  name: "jwt-example"&#x000A;  namespace: mtls-service&#x000A;spec:&#x000A;  selector:&#x000A;    matchLabels:&#x000A;      app: httpbin&#x000A;  jwtRules:&#x000A;  - issuer: "testing@secure.istio.io"&#x000A;    jwksUri: "https://raw.githubusercontent.com/istio/istio/release-1.8/security/tools/jwt/samples/jwks.json"&#x000A;EOF&#x000A;</code></pre>
</li>
<li>
<p>Verify that a request with an invalid JWT is denied:</p>
<pre><code class="language-bash prettyprint">kubectl exec "$(kubectl get pod -l app=sleep -n mtls-client -o jsonpath={.items..metadata.name})" -c sleep -n mtls-client -- curl "http://httpbin.mtls-service:8000/headers" -s -o /dev/null -H "Authorization: Bearer invalidToken" -w "%{http_code}\n"&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code class="language-bash prettyprint">401&#x000A;</code></pre>
</li>
<li>
<p>Verify that a request without any JWT is allowed:</p>
<pre><code class="language-bash prettyprint">kubectl exec "$(kubectl get pod -l app=sleep -n mtls-client -o jsonpath={.items..metadata.name})" -c sleep -n mtls-client -- curl "http://httpbin.mtls-service:8000/headers" -s -o /dev/null -w "%{http_code}\n"&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code class="language-bash prettyprint">200&#x000A;</code></pre>
</li>
</ol>
<h3>AuthorizationPolicy</h3>
<ol start="4">
<li>
<p>Create an AuthorizationPolicy resource for the <code>httpbin</code> workload in the
<code>mtls-service</code> namespace:</p>
<pre><code class="language-bash prettyprint">kubectl apply -f - &lt;&lt;EOF&#x000A;apiVersion: security.istio.io/v1beta1&#x000A;kind: AuthorizationPolicy&#x000A;metadata:&#x000A;  name: require-jwt&#x000A;  namespace: mtls-service&#x000A;spec:&#x000A;  selector:&#x000A;    matchLabels:&#x000A;      app: httpbin&#x000A;  action: ALLOW&#x000A;  rules:&#x000A;  - from:&#x000A;    - source:&#x000A;       requestPrincipals: ["testing@secure.istio.io/testing@secure.istio.io"]&#x000A;EOF&#x000A;</code></pre>
<p>The policy requires all requests to the <code>httpbin</code> workload to have a valid
JWT with <code>requestPrincipal</code> set to <code>testing@secure.istio.io/testing@secure.istio.io</code>.
Istio constructs the <code>requestPrincipal</code> by combining the <code>iss</code> and <code>sub</code> of
the JWT token with a / separator as shown:</p>
</li>
<li>
<p>Download a legitimate JWT that can be used to send accepted requests:</p>
<pre><code class="language-bash prettyprint">TOKEN=$(curl https://raw.githubusercontent.com/istio/istio/release-1.8/security/tools/jwt/samples/demo.jwt -s) &amp;&amp; echo "$TOKEN" | cut -d '.' -f2 - | base64 --decode -&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code class="language-bash prettyprint">{"exp":4685989700,"foo":"bar","iat":1532389700,"iss":"testing@secure.istio.io","sub":"testing@secure.istio.io"}&#x000A;</code></pre>
<p>Note that the <code>iss</code> and <code>sub</code> keys are set to <code>testing@secure.istio.io</code>.
This causes Istio to generate the attribute <code>requestPrincipal</code> with the
value <code>testing@secure.istio.io/testing@secure.istio.io</code>:</p>
</li>
<li>
<p>Verify that a request with a valid JWT is allowed:</p>
<pre><code class="language-bash prettyprint">kubectl exec "$(kubectl get pod -l app=sleep -n mtls-client -o jsonpath={.items..metadata.name})" -c sleep -n mtls-client -- curl "http://httpbin.mtls-service:8000/headers" -s -o /dev/null -H "Authorization: Bearer $TOKEN" -w "%{http_code}\n"&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code class="language-bash prettyprint">200&#x000A;</code></pre>
</li>
<li>
<p>Verify that a request without a JWT is denied:</p>
<pre><code class="language-bash prettyprint">kubectl exec "$(kubectl get pod -l app=sleep -n mtls-client -o jsonpath={.items..metadata.name})" -c sleep -n mtls-client -- curl "http://httpbin.mtls-service:8000/headers" -s -o /dev/null -w "%{http_code}\n"&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code class="language-bash prettyprint">403&#x000A;</code></pre>
</li>
</ol>
<h2 id="step7">Task 5. Authorizing requests based on method and path</h2>
<p>This task shows you how to control access to workloads by using an
AuthorizationPolicy that evaluates the request type and URL.</p>
<ol>
<li>
<p>Update the <code>require-jwt</code> authorization policy for the <code>httpbin</code> workload in
the <code>mtls-service</code> namespace. The new policy will still have the JWT
requirement that you set up in the previous task. In addition, you are going
to limit the type of HTTP requests, so that clients can only perform GET
requests to the <code>/ip</code> endpoint:</p>
<pre><code class="language-bash prettyprint">kubectl apply -f - &lt;&lt;EOF&#x000A;apiVersion: security.istio.io/v1beta1&#x000A;kind: AuthorizationPolicy&#x000A;metadata:&#x000A;  name: require-jwt&#x000A;  namespace: mtls-service&#x000A;spec:&#x000A;  selector:&#x000A;    matchLabels:&#x000A;      app: httpbin&#x000A;  action: ALLOW&#x000A;  rules:&#x000A;  - from:&#x000A;    - source:&#x000A;        requestPrincipals: ["testing@secure.istio.io/testing@secure.istio.io"]&#x000A;    to:&#x000A;    - operation:&#x000A;        methods: ["GET"]&#x000A;        paths: ["/ip"]&#x000A;EOF&#x000A;</code></pre>
</li>
<li>
<p>Verify that a request to the <code>httpbin</code>'s <code>/ip</code> endpoint works:</p>
<pre><code class="language-bash prettyprint">kubectl exec "$(kubectl get pod -l app=sleep -n mtls-client -o jsonpath={.items..metadata.name})" -c sleep -n mtls-client -- curl "http://httpbin.mtls-service:8000/ip" -s -o /dev/null -H "Authorization: Bearer $TOKEN" -w "%{http_code}\n"&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code class="language-bash prettyprint">200&#x000A;</code></pre>
</li>
<li>
<p>Verify that a request to the <code>httpbin</code>'s <code>/headers</code> endpoint is denied:</p>
<pre><code class="language-bash prettyprint">kubectl exec "$(kubectl get pod -l app=sleep -n mtls-client -o jsonpath={.items..metadata.name})" -c sleep -n mtls-client -- curl "http://httpbin.mtls-service:8000/headers" -s -o /dev/null -H "Authorization: Bearer $TOKEN" -w "%{http_code}\n"&#x000A;</code></pre>
<p><strong>Output (do not copy)</strong></p>
<pre><code class="language-bash prettyprint">403&#x000A;</code></pre>
</li>
<li>
<p>Remove the <strong>require-jwt</strong> authorization policy by running this command:</p>
<pre><code class="language-bash prettyprint">kubectl delete AuthorizationPolicy require-jwt -n mtls-service&#x000A;</code></pre>
</li>
</ol>
<h2 id="step8">Review</h2>
<p>In this lab, you explored <strong>mutual TLS</strong> authentication in Istio. You saw how
PERMISSIVE mode mTLS allows services to receive both plaintext and mTLS
traffic from clients, allowing you to incrementally adopt mTLS. You also
enabled STRICT mode mTLS across your service mesh effectively blocking
plaintext traffic to all your Istio injected services and then you scoped
STRICT mode mTLS down to a single namespace.</p>
<p>In addition, you explored <strong>RequestAuthentication</strong> and <strong>AuthorizationPolicy</strong>
resources in Istio.</p>
<h3>Next Steps</h3>
<ul>
<li>Learn more about <a href="https://istio.io/docs/concepts/security/" target="_blank">Concepts: Istio Security</a>.</li>
<li>Learn more about expanding authorization to entire namespaces <a href="https://istio.io/docs/tasks/security/authz-http/#namespace-level-access-control" target="_blank">here</a>.</li>
<li>Learn about <a href="https://istio.io/docs/tasks/traffic-management/egress/egress-tls-origination/" target="_blank">TLS Origination for Egress Traffic</a>.</li>
</ul>
<h2 id="step9">End your lab</h2>
<p>When you have completed your lab, click <strong>End Lab</strong>. Qwiklabs removes the resources you‚Äôve used and cleans the account for you.</p>
<p>You will be given an opportunity to rate the lab experience. Select the applicable number of stars, type a comment, and then click <strong>Submit</strong>.</p>
<p>The number of stars indicates the following:</p>
<ul>
<li>1 star = Very dissatisfied</li>
<li>2 stars = Dissatisfied</li>
<li>3 stars = Neutral</li>
<li>4 stars = Satisfied</li>
<li>5 stars = Very satisfied</li>
</ul>
<p>You can close the dialog box if you don't want to provide feedback.</p>
<p>For feedback, suggestions, or corrections, please use the <strong>Support</strong> tab.</p>

<p>Copyright 2021 Google LLC All rights reserved. Google and the Google logo are trademarks of Google LLC. All other company and product names may be trademarks of the respective companies with which they are associated.</p>



</div>
</div>


<div class='hidden js-end-lab-button-container lab-content__end-lab-button'>
<ql-lab-control-button class='js-end-lab-button' running></ql-lab-control-button>
</div>
<!-- / TODO: Move recommendations into the end lab modal -->
</ql-drawer-content>
<ql-drawer end id='outline-drawer' open slot='drawer' width='320'>
<div class='js-lab-content-outline lab-content__outline'>
<a href='#step1'>Overview</a><a href='#step2'>Task 0. Lab Setup</a><a href='#step3'>Task 1. Confirm Anthos Service Mesh setup</a><a href='#step4'>Task 2. Deploy sleep and httpbin services</a><a href='#step5'>Task 3. Understand authentication and enable service to service authentication with mTLS</a><a href='#step6'>Task 4. Leverage RequestAuthentication and AuthorizationPolicy resources</a><a href='#step7'>Task 5. Authorizing requests based on method and path</a><a href='#step8'>Review</a><a href='#step9'>End your lab</a>
</div>
</ql-drawer>
</ql-drawer-container>
</ql-drawer-content>
</ql-drawer-container>
<div class='lab-introduction js-lab-introduction is-hidden'>
<div class='lab-introduction__inner'>
<h1 class='headline-1'>Welcome to Your First Lab!</h1>
<ql-icon-button class='js-skip-button'>close</ql-icon-button>
<div class='lab-introduction__video'>
<iframe allow='autoplay; encrypted-media' allowfullscreen frameborder='0' id='lab-introduction' src='https://www.youtube.com/embed/yF7EDXKTmoQ?enablejsapi=1&amp;rel=0&amp;showinfo=0'></iframe>
</div>
<a class='js-skip-button button button--outline'>Skip this video</a>
</div>
</div>



</div>
</main>


<div class='modal fade' id='lab-details-modal'>
<div class='modal-container'>
<div class='mdl-shadow--24dp modal-content'>
<div class='modal-body'>
<p class='l-mbm'>
Architecting Hybrid Infrastructure with Anthos: Adopt service mesh authentication, and authorization using Istio.
</p>
<p class='small-label l-mbs'>
<strong>
Duration:
</strong>
7m setup
&middot;
1440m access
&middot;
1440m completion
</p>
<p class='small-label l-mbs'>
<span><strong>Levels: </strong>intermediate</span>
</p>
<p class='small-label'>
<strong>
Permalink:
</strong>
<a href="https://googlecoursera.qwiklabs.com/catalog_lab/2075">https://googlecoursera.qwiklabs.com/catalog_lab/2075</a>
</p>
</div>
<div class='modal-actions'>
<a class='button button--text' data-dismiss='modal'>
Got It
</a>
</div>


</div>
</div>
<iframe class='l-ie-iframe-fix'></iframe>
</div>
<div class='modal fade' id='lab-review-modal'>
<div class='modal-container'>
<div class='mdl-shadow--24dp modal-content'>
<form class="simple_form js-lab-review-form" id="edit_lab_review_12110898" action="/lab_reviews/12110898" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="_method" value="patch" /><div class='modal-body'>
<p class='label'>
How satisfied are you with this lab?*
</p>
<div class='rateit js-rateit' data-rateit-max='5' data-rateit-min='0' data-rateit-resetable='false' data-rateit-step='1' data-rateit-value='5'></div>
<div class='l-mtm'>

<div class="control-group hidden lab_review_user_id"><div class="controls"><input class="hidden" type="hidden" value="3894861" name="lab_review[user_id]" id="lab_review_user_id" /></div></div>
<div class="control-group hidden lab_review_classroom_id"><div class="controls"><input class="hidden" type="hidden" name="lab_review[classroom_id]" id="lab_review_classroom_id" /></div></div>
<div class="control-group hidden lab_review_lab_id"><div class="controls"><input class="hidden" type="hidden" value="2075" name="lab_review[lab_id]" id="lab_review_lab_id" /></div></div>
<div class="control-group hidden lab_review_focus_id"><div class="controls"><input class="hidden" type="hidden" name="lab_review[focus_id]" id="lab_review_focus_id" /></div></div>
<div class="control-group hidden lab_review_rating"><div class="controls"><input class="hidden js-rating-input" type="hidden" value="2" name="lab_review[rating]" id="lab_review_rating" /></div></div>
<div class="control-group text optional lab_review_comment"><label class="text optional control-label" for="lab_review_comment">Comment</label><div class="controls"><textarea class="text optional" name="lab_review[comment]" id="lab_review_comment">
</textarea></div></div>
</div>
</div>
<div class='modal-actions'>
<a class='button button--text' data-dismiss='modal'>
Cancel
</a>
<input type="submit" name="commit" value="Submit" disabled="disabled" id="submit" data-disabled="false" class="button" data-disable-with="Submit" />
</div>
</form>

</div>
</div>
<iframe class='l-ie-iframe-fix'></iframe>
</div>


<script>
  $( function() {
    ql.initMaterialInputs();
    initChosen();
    initSearch();
    initTabs();
    ql.list.init();
    ql.favoriting.init();
    ql.header.myAccount.init();
    initTooltips();
    ql.autocomplete.init();
    ql.modals.init();
    ql.toggleButtons.init();
    ql.analytics.init();
    ql.labControlPanel.addRecaptchaErrorHandler();
  initLabContent();
  ql.labOutline.links.init();
  initLabReviewModal();
  ql.labAssessment.init();
  ql.labIntroduction.init( true );
  ql.labData.init();
  initLabTranslations( {"are_you_sure":"All done? If you end this lab, you will lose all your work. You may not be able to restart the lab if there is a quota limit. Are you sure you want to end this lab?\n","in_progress":"*In Progress*","ending":"*Ending*","starting":"*Starting, please wait*","end_concurrent_labs":"Sorry, you can only run one lab at a time. To start this lab, please confirm that you want all of your existing labs to end.\n","copied":"Copied","no_resource":"Error retrieving resource.","no_support":"No Support","mac_press":"Press ‚åò-C to copy","thanks_review":"Thanks for reviewing this lab.","windows_press":"Press Ctrl-C to copy","days":"days"} );
  ql.labRun.init();
  ql.chat.init();
  ql.initHeader();
  ql.navigation.init();
  ql.navPanel.init();
  ql.navigation.init();
  
  });
</script>

</body>
</html>



<!DOCTYPE html>
<html lang='en'>
<head>
<title>Securing Google Kubernetes Engine with Cloud IAM and Pod Security Policies | Qwiklabs</title>
<script>
//<![CDATA[
window.gon={};gon.current_user={"firstname":"DANIEL","lastname":"ENRIQUE SANDOVAL SANCHEZ","fullname":"DANIEL ENRIQUE SANDOVAL SANCHEZ","company":"Coursera","email":"desandovals@liverpool.com.mx","origin":"googlecoursera-run, lti-coursera","subscriptions":0,"id":"40414ff5fc280f833d9acca966912f93","qlCreatedAt":"2020-11-17 20:45:59 UTC","optIn":null,"current_organization_id":null,"current_organization_role":null};gon.segment="j4Im8pqIko0Lxq4wVVZWMPMM0EroHUvb";gon.deployment="googlecoursera-run";gon.content={"type":"Lab","id":2305,"name":"Securing Google Kubernetes Engine with Cloud IAM and Pod Security Policies"};
//]]>
</script>
<script>
  dataLayer = [
    {user: gon.current_user},
    {content: gon.content}
  ];
</script>
<script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer',"GTM-TQR88QK");
</script>
<script>
  EVENT_SOURCE_BASE_URL = "https://googlecoursera-run.qwiklabs.com/nchan-sub?id=";
</script>
<script src="https://cdn.qwiklabs.com/assets/hallofmirrors/polyfills/webcomponents-loader-408088dc333247a761de5f2b2a4ba1cabd2bc36579f83ba92a559eb3682a9b77.js"></script>
<script src="https://cdn.qwiklabs.com/assets/vendor-45d462772c30000424907184f70c7157e95fb6227698d1671c5051818a6f60d8.js"></script>
<script src="https://cdn.qwiklabs.com/assets/application-6874b164d8346f46605fc772a6f7375a39626ffc9f6d168e23a3a8c40bb6fd28.js"></script>
<script src="https://cdn.qwiklabs.com/assets/hallofmirrors/hallofmirrors-b7ff781d00ceebdf75589f58475cea695bafd8d5cc1f3eb4baf6122ed4a4b736.js"></script>
<!--[if lt IE 9]>
<script src='http://html5shim.googlecode.com/svn/trunk/html5.js' type='text/javascript'></script>
<![endif]-->
<!--[endif]>  <![endif]-->
<script type='application/ld+json'>
{
  "@context": "http://schema.org",
  "@type": "WebSite",
  "url": "https://www.qwiklabs.com/",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "https://www.qwiklabs.com/catalog?keywords={search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
</script>
<script id='ze-snippet' src='https://static.zdassets.com/ekr/snippet.js?key=511e4158-0aec-4e3c-b2e6-4daa1769f51e'></script>


<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="2kXBag7kOQUNTg2Y0gjoOb9XhzUCBMhGd3Iur4+ZYVSDG8KVF0rT8mH9KCDwrpS/ZOE9Ys+tmnsHECAbea9ilA==" />
<meta content='width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0' name='viewport'>
<meta content='1rRsY0INj8RvwB5EF5pwdxt2A2P9aDgAlsICaJ0d5w0' name='google-site-verification'>
<meta content='#3681E4' property='msapplication-TileColor'>
<meta content='/favicon-144.png' property='msapplication-TileImage'>
<meta content='[{&quot;id&quot;:&quot;recaptcha_experiment&quot;,&quot;optimize_id&quot;:&quot;dpViOcLkT3qS4TvL2mRojA&quot;,&quot;title&quot;:&quot;No Recaptcha shown for trusted users&quot;,&quot;variant_index&quot;:0,&quot;variant&quot;:&quot;original&quot;}]' name='active-experiments'>
<meta content='{&quot;userId&quot;:3894861}' name='help-api-product-data'>
<meta content='Architecting with Google Kubernetes Engine: Securing Kubernetes Engine with Cloud IAM and Pod Security Policies' name='description'>
<meta content='Qwiklabs' name='author'>
<meta content='Securing Google Kubernetes Engine with Cloud IAM and Pod Security Policies | Qwiklabs' property='og:title'>
<meta content='website' property='og:type'>
<meta content='/favicon-144.png' property='og:image'>
<meta content='Qwiklabs' property='og:site_name'>
<meta content='Architecting with Google Kubernetes Engine: Securing Kubernetes Engine with Cloud IAM and Pod Security Policies' property='og:description'>
<meta content='/qwiklabs_logo_900x887.png' property='og:logo' size='900x887'>
<meta content='/qwiklabs_logo_994x187.png' property='og:logo' size='994x187'>


<link href='/favicon-32.png' rel='shortcut icon'>
<link color='#3681E4' href='/favicon-svg.svg' rel='mask-icon'>
<link href='/favicon-180.png' rel='apple-touch-icon-precomposed'>



<link rel="stylesheet" media="screen" href="https://fonts.googleapis.com/css?family=Oswald:400|Roboto+Mono:400,700|Roboto:300,400,500,700|Google+Sans:300,400,500,700|Google+Sans+Display:400|Material+Icons|Google+Material+Icons" />


<link rel="stylesheet" media="all" href="https://cdn.qwiklabs.com/assets/application-cf67fd00dd904ecce1e24779d7504aefc7fbd5d00696246fa80212743a81bf07.css" />



</head>
<body class='lab-show l-full no-nav application-new focuses focuses-show lab-show l-full no-nav '>
<noscript>
<iframe height='0' src='https://www.googletagmanager.com/ns.html?id=GTM-TQR88QK' style='display:none;visibility:hidden;' width='0'></iframe>
</noscript>
<span class='hidden' id='flash-sibling-before'></span>

<div class='header-container'>
<div class='header'>
<ql-icon-button class='js-nav-toggle header__nav-panel-button l-mrm'>menu</ql-icon-button>
<div class='header__title'>
<ql-icon-button label="Back" href="https://www.coursera.org/" id="2411bc2e70d0545b" target="_self">arrow_back</ql-icon-button><div class="mdl-tooltip" data-mdl-for="2411bc2e70d0545b">Back</div>

<h1 class='headline-5'>
Securing Google Kubernetes Engine with Cloud IAM and Pod Security Policies
</h1>
</div>
<div class='header__actions'>
<ql-icon-button class='header__button--search js-header-search-bar-button'>search</ql-icon-button>
<ql-icon-button id='control-panel-target' style='display: none;'>
dashboard
</ql-icon-button>
<ql-menu for='control-panel-target' id='control-panel-menu'></ql-menu>

<ql-icon-button id='help-menu-button'>help</ql-icon-button>
<div class='mdl-tooltip js-tooltip' data-mdl-for='help-menu-button'>
Help
</div>
<ql-menu for='help-menu-button' id='help-menu'>
<ql-menu-item>
<ql-help context='lab' data-analytics-action='opened_help' data-analytics-label='lab' productdata='{&quot;userId&quot;:3894861}'>
Help Center
</ql-help>
</ql-menu-item>
<ql-menu-item>
<a target="_blank" class="ql-body-1" href="https://support.google.com/qwiklabs/contact/contact_us">Email support</a>
</ql-menu-item>
<ql-menu-item>
<a class='ql-body-1' onClick='ql.chat.open()'>Chat support</a>
</ql-menu-item>
</ql-menu>

<ql-icon-button id='language'>language</ql-icon-button>
<div class='mdl-menu mdl-menu__bottom-right mdl-js-menu elevation-3' for='language'>
<a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="ar" href="/focuses/15531648?locale=ar&amp;parent=lti_session">العربية‬‎
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="de" href="/focuses/15531648?locale=de&amp;parent=lti_session">Deutsch
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="en" href="/focuses/15531648?locale=en&amp;parent=lti_session">English
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="es" href="/focuses/15531648?locale=es&amp;parent=lti_session">español (Latinoamérica)
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="fr" href="/focuses/15531648?locale=fr&amp;parent=lti_session">français
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="id" href="/focuses/15531648?locale=id&amp;parent=lti_session">bahasa Indonesia
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="it" href="/focuses/15531648?locale=it&amp;parent=lti_session">Italiano
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="ja" href="/focuses/15531648?locale=ja&amp;parent=lti_session">日本語
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="ko" href="/focuses/15531648?locale=ko&amp;parent=lti_session">한국어
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="pl" href="/focuses/15531648?locale=pl&amp;parent=lti_session">Polski
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="pt_BR" href="/focuses/15531648?locale=pt_BR&amp;parent=lti_session">português (Brasil)
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="pt_PT" href="/focuses/15531648?locale=pt_PT&amp;parent=lti_session">português (Portugal)
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="ru" href="/focuses/15531648?locale=ru&amp;parent=lti_session">русский
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="tr" href="/focuses/15531648?locale=tr&amp;parent=lti_session">Türkçe
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="zh" href="/focuses/15531648?locale=zh&amp;parent=lti_session">简体中文
</a><a class="mdl-menu__item locale-link" data-analytics-action="changed_locale" data-analytics-label="zh_TW" href="/focuses/15531648?locale=zh_TW&amp;parent=lti_session">繁體中文
</a></div>
<button class='icon-button' id='my_account'>
<ql-avatar></ql-avatar>
</button>
<ql-menu for='my_account' open>
<div class='my-account-menu'>
<ql-avatar class='l-mtl l-mbl' size='120'></ql-avatar>
<div class='my-account-menu__user-info l-mbl'>
<h4 class='ql-subhead-1'>DANIEL ENRIQUE SANDOVAL SANCHEZ</h4>
<p class='ql-body-2 text--light'>desandovals@liverpool.com.mx</p>
<p class='ql-body-2 text--light'>
</p>
<a class="text--green ql-subhead-2" href="/my_account/payments"><ql-chip positive>
0 Credits
</ql-chip>
</a></div>
<div class='buttons l-mbl'>
<a class="button button--hairline" id="settings" href="/my_account/profile">Settings</a>
</div>
<hr>
<ql-button data-analytics-action='clicked_sign_out' href='/users/sign_out' method='delete'>
Sign Out
</ql-button>
<div class='privacy l-mtl'>
<a class="ql-caption text--light" href="/privacy_policy">Privacy</a>
<span class='ql-caption text--light l-mls l-mrs'>&middot;</span>
<a class="ql-caption text--light" href="/terms_of_service">Terms</a>
</div>
</div>
</ql-menu>

</div>
</div>
<div class='header__search-bar js-header-search-bar'>
<form class="js-search-form-mobile" onsubmit="ql.searchFilter(); return false;" action="/searches/elasticsearch" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="85hJdlBY3NmC8UYV/u4XCyHtUR45ktqoG2gRMEx4tKGqxkqJSfY2Lu5CY63cSGuN+lvrSfQ7iJVrCh+Euk63YQ==" />
<input type="text" name="keywords" id="keywords" placeholder="Search" maxlength="255" aria-label="catalog search bar" />
</form>

<ql-icon-button class='js-close-search-bar'>close</ql-icon-button>
</div>
</div>

<nav class='nav-bar'>
<a class="nav-bar__item js-navigation-button" href="/"><ql-icon class='nav-bar__item__icon'>
home
</ql-icon>
<span class='nav-bar__item__label'>
Home
</span>
</a>
<a class="nav-bar__item js-navigation-button" href="/catalog"><ql-icon class='nav-bar__item__icon'>
school
</ql-icon>
<span class='nav-bar__item__label'>
Catalog
</span>
</a>
<a class="nav-bar__item js-navigation-button" href="/my_learning"><ql-icon class='nav-bar__item__icon'>
event_note
</ql-icon>
<span class='nav-bar__item__label'>
My Learning
</span>
</a>
</nav>

<nav class='nav-panel js-nav-panel'>
<div class='nav-panel__logo'>
<div class='logo logo--blue'></div>
</div>
<a title="Home" tabindex="-1" class="nav-panel__item js-navigation-button" href="/"><ql-icon class='nav-panel__item__icon'>
home
</ql-icon>
<div class='nav-panel__item__label'>
Home
</div>
</a>
<a title="Catalog" tabindex="-1" class="nav-panel__item js-navigation-button" href="/catalog"><ql-icon class='nav-panel__item__icon'>
school
</ql-icon>
<div class='nav-panel__item__label'>
Catalog
</div>
</a>
<a title="My Learning" tabindex="-1" class="nav-panel__item js-navigation-button" href="/my_learning"><ql-icon class='nav-panel__item__icon'>
event_note
</ql-icon>
<div class='nav-panel__item__label'>
My Learning
</div>
</a>
<div class='nav-panel__spacer'></div>
<a title="Profile" tabindex="-1" class="nav-panel__item js-navigation-button" href="/my_account/profile"><ql-icon class='nav-panel__item__icon'>
account_circle
</ql-icon>
<div class='nav-panel__item__label'>
Profile
</div>
</a>
<a title="Credits &amp; Subscriptions" tabindex="-1" class="nav-panel__item js-navigation-button" href="/my_account/credits"><ql-icon class='nav-panel__item__icon'>
money
</ql-icon>
<div class='nav-panel__item__label'>
Credits &amp; Subscriptions
</div>
</a>
<a title="Security" tabindex="-1" class="nav-panel__item js-navigation-button" href="/my_account/security"><ql-icon class='nav-panel__item__icon'>
security
</ql-icon>
<div class='nav-panel__item__label'>
Security
</div>
</a>
<div class='nav-panel__spacer'></div>
<a class="nav-panel__item" tabindex="-1" href="#"><ql-help>
<div class='nav-panel__help-item'>
<ql-icon class='nav-panel__item__icon'>help</ql-icon>
<div class='nav-panel__item__label'>
Help
</div>
</div>
</ql-help>
</a><div class='nav-panel__small-links'>
<a tabindex="-1" href="/privacy_policy">Privacy</a>
<a tabindex="-1" href="/terms_of_service">Terms</a>
</div>
</nav>
<div class='nav-panel__overlay js-nav-toggle'></div>

<main class='js-main'>
<div class='l-main-wrapper' id='main-wrapper'>







<div class='lab-assessment__tab js-open-lab-assessment-panel'>
<h6 class='js-lab-assessment-total-score'>
&mdash;/30
</h6>
</div>
<div class='lab-assessment__panel js-lab-assessment-panel'>
<div class='lab-assessment__panel__header'>
<h4>Checkpoints</h4>
<ql-icon-button class='js-close-lab-assessment-panel'>arrow_forward</ql-icon-button>
</div>
<div class='lab-assessment__step'>
<p class='lab-assessment__step__title'>
Grant the GKE Admin Cloud IAM Role to username 2
</p>
<div class='lab-assessment__step__action'>
<a class='button js-show-run-step-button' step_no='1'>
Check my progress
</a>
<p class='lab-assessment__step__score'>
<span class='js-assessment-step-score-1'>
</span>
/ 5
</p>
</div>
</div>

<div class='lab-assessment__step'>
<p class='lab-assessment__step__title'>
Grant the ServiceAccountUser IAM Role to Username 2
</p>
<div class='lab-assessment__step__action'>
<a class='button js-show-run-step-button' step_no='2'>
Check my progress
</a>
<p class='lab-assessment__step__score'>
<span class='js-assessment-step-score-2'>
</span>
/ 5
</p>
</div>
</div>

<div class='lab-assessment__step'>
<p class='lab-assessment__step__title'>
Create a Pod Security Policy
</p>
<div class='lab-assessment__step__action'>
<a class='button js-show-run-step-button' step_no='3'>
Check my progress
</a>
<p class='lab-assessment__step__score'>
<span class='js-assessment-step-score-3'>
</span>
/ 5
</p>
</div>
</div>

<div class='lab-assessment__step'>
<p class='lab-assessment__step__title'>
Bind Username 1 to the cluster admin role and create the restricted-pods role
</p>
<div class='lab-assessment__step__action'>
<a class='button js-show-run-step-button' step_no='4'>
Check my progress
</a>
<p class='lab-assessment__step__score'>
<span class='js-assessment-step-score-4'>
</span>
/ 5
</p>
</div>
</div>

<div class='lab-assessment__step'>
<p class='lab-assessment__step__title'>
Enable Pod Security Policies
</p>
<div class='lab-assessment__step__action'>
<a class='button js-show-run-step-button' step_no='5'>
Check my progress
</a>
<p class='lab-assessment__step__score'>
<span class='js-assessment-step-score-5'>
</span>
/ 5
</p>
</div>
</div>

<div class='lab-assessment__step'>
<p class='lab-assessment__step__title'>
Rotate IP Address and Credentials
</p>
<div class='lab-assessment__step__action'>
<a class='button js-show-run-step-button' step_no='6'>
Check my progress
</a>
<p class='lab-assessment__step__score'>
<span class='js-assessment-step-score-6'>
</span>
/ 5
</p>
</div>
</div>

</div>
<ql-drawer-container class='js-lab-state' data-analytics-payload='{&quot;label&quot;:&quot;Securing Google Kubernetes Engine with Cloud IAM and Pod Security Policies&quot;,&quot;lab_name&quot;:&quot;Securing Google Kubernetes Engine with Cloud IAM and Pod Security Policies&quot;,&quot;classroom_name&quot;:null,&quot;deployment&quot;:&quot;googlecoursera-run&quot;}' data-focus-id='15531648' data-lab-billing-limit='0.0' data-lab-duration='5400' data-parent='lti_session' data-recaptcha-enabled id='lab-container'>
<ql-drawer id='terminal-drawer' slot='drawer' style='width: calc(100% - 480px)'>
<iframe allow='clipboard-read' class='terminal' id='embedded-resource'></iframe>
</ql-drawer>
<ql-drawer-content class='js-lab-wrapper' id='lab-content' slot='drawer-content'>
<ql-drawer-container id='lab-content-container'>
<ql-drawer id='control-panel-drawer' open slot='drawer' width='320'>
<ql-lab-control-panel class='ql-lab-control-panel__max-height control-panel js-lab-control-panel' connectionFiles='[]' labControlButton='{&quot;disabled&quot;:false,&quot;pending&quot;:false,&quot;running&quot;:false}' labDetails='[]' labTimer='{&quot;ticking&quot;:false,&quot;secondsRemaining&quot;:5400}' studentResources='[]'>
<script src="https://www.recaptcha.net/recaptcha/api.js?render=6LeVI8IUAAAAAJNdox5eTkYrw9SbvhZ1TFyv3iHr"   ></script>
        <script>
          // Define function so that we can call it again later if we need to reset it
          // This executes reCAPTCHA and then calls our callback.
          function executeRecaptchaForStartLab() {
            grecaptcha.ready(function() {
              grecaptcha.execute('6LeVI8IUAAAAAJNdox5eTkYrw9SbvhZ1TFyv3iHr', {action: 'start_lab'}).then(function(token) {
                setInputWithRecaptchaResponseTokenForStartLab('g-recaptcha-response-data-start-lab', token)
              });
            });
          };
          // Invoke immediately
          executeRecaptchaForStartLab()

          // Async variant so you can await this function from another async function (no need for
          // an explicit callback function then!)
          // Returns a Promise that resolves with the response token.
          async function executeRecaptchaForStartLabAsync() {
            return new Promise((resolve, reject) => {
              grecaptcha.ready(async function() {
                resolve(await grecaptcha.execute('6LeVI8IUAAAAAJNdox5eTkYrw9SbvhZ1TFyv3iHr', {action: 'start_lab'}))
              });
            })
          };

                    var setInputWithRecaptchaResponseTokenForStartLab = function(id, token) {
            var element = document.getElementById(id);
            element.value = token;
          }

        </script>
<input type="hidden" name="g-recaptcha-response-data[start_lab]" id="g-recaptcha-response-data-start-lab" data-sitekey="6LeVI8IUAAAAAJNdox5eTkYrw9SbvhZ1TFyv3iHr" class="g-recaptcha g-recaptcha-response "/>

<div class='hidden' id='recaptcha-v2-start-lab' slot='recaptcha'>
<script src="https://www.recaptcha.net/recaptcha/api.js" async defer ></script>
<div data-sitekey="6LeOI8IUAAAAAPkHlMAE9NReCD_1WD81iYlBlCnV" data-callback="recaptchaComplete" data-expired-callback="expireV2Token" class="g-recaptcha "></div>
          <noscript>
            <div>
              <div style="width: 302px; height: 422px; position: relative;">
                <div style="width: 302px; height: 422px; position: absolute;">
                  <iframe
                    src="https://www.recaptcha.net/recaptcha/api/fallback?k=6LeOI8IUAAAAAPkHlMAE9NReCD_1WD81iYlBlCnV"
                    name="ReCAPTCHA"
                    style="width: 302px; height: 422px; border-style: none; border: 0; overflow: hidden;">
                  </iframe>
                </div>
              </div>
              <div style="width: 300px; height: 60px; border-style: none;
                bottom: 12px; left: 25px; margin: 0px; padding: 0px; right: 25px;
                background: #f9f9f9; border: 1px solid #c1c1c1; border-radius: 3px;">
                <textarea id="g-recaptcha-response" name="g-recaptcha-response"
                  class="g-recaptcha-response"
                  style="width: 250px; height: 40px; border: 1px solid #c1c1c1;
                  margin: 10px 25px; padding: 0px; resize: none;">
                </textarea>
              </div>
            </div>
          </noscript>

</div>
</ql-lab-control-panel>
</ql-drawer>
<ql-drawer-content id='lab-instructions' slot='drawer-content'>
<div class='alert alert--fake js-alert'>
<p class='alert__message js-alert-message'></p>
<a class='alert__close js-alert-close'>
<i class='fa fa-times'></i>
</a>
<iframe class='l-ie-iframe-fix'></iframe>
</div>
<div class='js-lab-content lab-content__renderable-instructions'>
<div class='lab-preamble'>
<h1 class='lab-preamble__title'>
Securing Google Kubernetes Engine with Cloud IAM and Pod Security Policies
</h1>
<div class='lab-preamble__details subtitle-headline-1'>
<span>1 hour 30 minutes</span>
<span>Free</span>
<div class='lab__rating'>
<a href="/focuses/15531648/reviews?parent=lti_session"><div class='rateit' data-rateit-readonly='true' data-rateit-value='3.6437'></div>

</a><a data-target='#lab-review-modal' data-toggle='modal'>
Rate Lab
</a>
</div>
</div>
</div>

<div class='js-markdown-instructions markdown-lab-instructions' id='markdown-lab-instructions'>



<h2 id="step1">Overview</h2>
<p>You will control access to GKE clusters using Cloud IAM. You will create a pod security policy to restrict privileged Pod creation, and you will test that policy. You will also perform IP address and credential rotation.</p>
<h2 id="step2">Objectives</h2>
<p>In this lab, you learn how to perform the following tasks:</p>
<ul>
<li>Use Cloud IAM to control GKE access</li>
<li>Create and use Pod security policies to control Pod creation</li>
<li>Perform IP address and credential rotation</li>
</ul>
<aside class="special"><p><strong>IMPORTANT: </strong></p>
<p>For this lab, Qwiklabs has provisioned you with two user names available in the <strong>Connection Details</strong> dialog. In this lab we will refer to these accounts as <strong>Username 1</strong> and <strong>Username 2</strong>.</p>
</aside>
<h2 id="step3">Task 1: Use Cloud IAM roles to grant administrative access to all the GKE clusters in the project</h2>
<h3>Sign in to the Google Cloud Console as the first user</h3>
<ol>
<li>Sign in to the Google Cloud Console in an Incognito window as usual with the <strong>Username 1</strong> provided in Qwiklabs. Note that both user names use the same password.</li>
<li>On the Google Cloud Console title bar, click <strong>Activate Cloud Shell (</strong> <img alt="e92fcd01cbb5e0ff.png" src="https://cdn.qwiklabs.com/G2OU7QatKvkGgxCZRcv3IFJd8GvwHIJz6JhAtOMT5cg%3D"><strong>)</strong>.</li>
<li>Click <strong>Continue</strong>.</li>
</ol>
<p>After a moment of provisioning, the Cloud Shell prompt appears:</p>
<aside class="warning"><p><strong>CAUTION: </strong></p>
<p>If you sign out of the <strong>Username 1</strong> account, the <strong>Username 2</strong> account may be deleted by Qwiklabs. So please remain signed in to <strong>Username 1</strong> until you are finished with this lab.</p>
</aside>
<h3>Sign in and explore the Google Cloud Console as the second user</h3>
<ol>
<li>Open another tab in your incognito window.</li>
<li>Browse to  <a href="http://console.cloud.google.com/" target="_blank">console.cloud.google.com</a>.</li>
<li>Click on the user icon in the top-right corner of the screen, and then click <strong>Add account</strong>.</li>
<li>Sign in to the Google Cloud Console with the <strong>Username 2</strong> provided in Qwiklabs. Again, note that both user names use the same password.</li>
</ol>
<aside class="warning"><p>Make sure you are on the <strong>Username 2</strong> Google Cloud Console tab.</p>
</aside>
<ol start="5">
<li>
<p>While logged in as <strong>Username 2</strong>, on the <strong>Navigation menu</strong> ( <img alt="8c24be286e75dbe7.png" src="https://cdn.qwiklabs.com/tkgw1TDgj4Q%2BYKQUW4jUFd0O5OEKlUMBRYbhlCrF0WY%3D">), click <strong>Kubernetes Engine &gt; Clusters</strong>.</p>
</li>
<li>
<p>Make sure that your lab Project ID is selected at the top of the page.</p>
</li>
</ol>
<p>Notice that the option to create a cluster is disabled.</p>
<p><img alt="46eab577f194c295.png" src="https://cdn.qwiklabs.com/21EJJfgsh0EbZNwLl%2BlWLiiIRee0bG%2BdXNiUo3kwiMI%3D"></p>
<aside class="special"><p><strong>Username 2</strong> currently has access to the project, but only possess the <strong>Viewer</strong> role, which makes all resources in the project visible, but read-only.</p>
</aside>
<h3>Grant the GKE Admin Cloud IAM Role to Username 2</h3>
<p>You will now allow <strong>Username 2</strong> to create a GKE cluster and deploy workloads by using primitive roles to grant a user permissions to administer all GKE clusters and manage resources inside those clusters in this project. The <strong>Username 1</strong> account has project owner rights and you will use that account to grant <strong>Username 2</strong> more rights.</p>
<ol>
<li>Switch back to the <strong>Username 1</strong> Google Cloud Console tab.</li>
</ol>
<aside class="warning"><p>Make sure you are on the <strong>Username 1</strong> Google Cloud Console tab.</p>
</aside>
<ol start="2">
<li>On the <strong>Navigation menu</strong> (<img alt="8c24be286e75dbe7.png" src="https://cdn.qwiklabs.com/tkgw1TDgj4Q%2BYKQUW4jUFd0O5OEKlUMBRYbhlCrF0WY%3D">), click <strong>IAM &amp; admin &gt; IAM</strong>.</li>
<li>In the <strong>IAM console</strong>, locate the row that corresponds to <strong>Username 2</strong>, and then click on the pencil icon at the right-end of that row to edit that user's permissions.</li>
</ol>
<p><img alt="7cc99b8b96e51709.png" src="https://cdn.qwiklabs.com/sp2K9C8Z4SHoaHKxZHc%2F09ZPWYVcH06ySsJiRvmo5%2FQ%3D"></p>
<ol start="4">
<li>Notice that <strong>Username 2</strong> currently has the <strong>Viewer</strong> role, which provides read access to all resources within the project.</li>
<li>Click <strong>ADD ANOTHER ROLE</strong> to add another dropdown selection for roles.</li>
<li>In the <strong>Select a role</strong> dropdown box, choose <strong>Kubernetes Engine &gt; Kubernetes Engine Cluster Admin</strong>.</li>
<li>Click <strong>ADD ANOTHER ROLE</strong> to add another dropdown selection for roles.</li>
<li>In the <strong>Select a role</strong> dropdown box, choose <strong>Kubernetes Engine &gt; Kubernetes Engine Developer</strong>.</li>
<li>Click <strong>SAVE</strong>.</li>
</ol>
<aside class="special"><p><strong>Note: </strong><strong>Username 2</strong> now has access to administer all GKE clusters in the project and to manage resources within those clusters. If this level of access is too broad for your organization, you can restrict the user's authority within a GKE cluster by using Kubernetes Role-based Access Control.</p>
</aside>
<p>Click <em>Check my progress</em> to verify the objective.
<ql-activity-tracking step="1">
Grant the GKE Cluster Admin and Developer IAM Roles to Username 2
</ql-activity-tracking></p>
<h3>Test the access of Username 2</h3>
<p>You will now verify your work by using <strong>Username 2</strong> to create a GKE cluster.</p>
<ol>
<li>Switch back to the <strong>Username 2</strong> Google Cloud Console tab.</li>
</ol>
<aside class="warning"><p>Make sure you are on the <strong>Username 2</strong> Google Cloud Console tab.</p>
</aside>
<ol start="2">
<li>While logged in as <strong>Username 2</strong>, on the <strong>Navigation menu</strong> (<img alt="8c24be286e75dbe7.png" src="https://cdn.qwiklabs.com/tkgw1TDgj4Q%2BYKQUW4jUFd0O5OEKlUMBRYbhlCrF0WY%3D">), click <strong>Kubernetes Engine &gt; Clusters</strong>.</li>
</ol>
<p>You should now see that the option to create a cluster is now enabled. You may need to refresh the web browser tab for <strong>Username 2</strong> to see the changes.</p>
<ol start="3">
<li>
<p>Click <strong>Create cluster</strong> to begin creating a GKE cluster.</p>
</li>
<li>
<p>Set the name of the cluster to <strong>standard-cluster-1</strong>, if that is not the default.</p>
</li>
<li>
<p>Confirm that a zonal, rather than regional, cluster is selected.</p>
</li>
<li>
<p>Choose zone <strong>us-central1-a</strong> for the cluster, if that is not the default.</p>
</li>
<li>
<p>In the <strong>default-pool</strong> section, set the <strong>Number of nodes</strong> to <strong>2</strong>.</p>
</li>
<li>
<p>Leave all other values at their defaults and click <strong>Create</strong>.</p>
</li>
</ol>
<p>The cluster begins provisioning, but soon fails.</p>
<aside class="warning"><p>This step of the lab is intended to fail.</p>
</aside>
<ol start="9">
<li>Click the notification icon in the toolbar at the top of the screen to view the error message.</li>
</ol>
<p><img alt="3f00eb68dc8a9792.png" src="https://cdn.qwiklabs.com/Ef2YLGDItY6Tp4LRQ3adQ9v3PJAA%2F7Y2vl%2BLCxvs7x0%3D"></p>
<p>Username 2 still lacks some of the rights necessary to deploy a cluster. This is because GKE leverages Google Cloud Compute Engine instances for the nodes. To deploy a GKE cluster, a user must also be assigned the iam.serviceAccountUser role on the Compute Engine default service account.</p>
<h3>Grant the ServiceAccountUser IAM Role to Username 2</h3>
<p>You will now use IAM to grant <strong>Username 2</strong> the iam.serviceAccountUser role so that <strong>Username 2</strong> may successfully deploy a GKE cluster.</p>
<ol>
<li>Switch back to the <strong>Username 1</strong> Google Cloud Console tab.</li>
</ol>
<aside class="warning"><p>Make sure you are on the <strong>Username 1</strong> Google Cloud Console tab.</p>
</aside>
<ol start="2">
<li>
<p>On the <strong>Navigation menu</strong> (<img alt="8c24be286e75dbe7.png" src="https://cdn.qwiklabs.com/tkgw1TDgj4Q%2BYKQUW4jUFd0O5OEKlUMBRYbhlCrF0WY%3D">), click <strong>IAM &amp; admin &gt; Service accounts</strong>.</p>
</li>
<li>
<p>In the <strong>IAM console</strong>, click the row that corresponds to the Compute Engine default service account to select it.</p>
</li>
<li>
<p>Click the <strong>Show Info Panel</strong> button on the upper right of the screen to open the information panel.</p>
</li>
</ol>
<p>The permissions information panel will open on the right side of the window.</p>
<ol start="5">
<li>On the right hand side of the page, in the <strong>Permissions</strong> pane, click <strong>Add Member</strong> .</li>
<li>Type the username for <strong>Username 2</strong> into the New members box. You can copy this name from the Qwiklabs Lab Details page.</li>
<li>In the <strong>Select a role</strong> box, choose <strong>Service Accounts &gt; Service Account User</strong>.</li>
<li>Click <strong>Save</strong>.</li>
</ol>
<p>Click <em>Check my progress</em> to verify the objective.
<ql-activity-tracking step="2">
Grant the Service Account User IAM Role to Username 2
</ql-activity-tracking></p>
<h3>Verify that Username 2 can create a GKE cluster</h3>
<p>You will now verify your work by using <strong>Username 2</strong> to create a GKE cluster.</p>
<ol>
<li>Switch back to the <strong>Username 2</strong> Google Cloud Console tab.</li>
</ol>
<aside class="warning"><p>Make sure you are on the <strong>Username 2</strong> Google Cloud Console tab.</p>
</aside>
<ol start="2">
<li>
<p>While logged in as <strong>Username 2</strong>, on the <strong>Navigation menu</strong> (<img alt="8c24be286e75dbe7.png" src="https://cdn.qwiklabs.com/tkgw1TDgj4Q%2BYKQUW4jUFd0O5OEKlUMBRYbhlCrF0WY%3D">), click <strong>Kubernetes Engine &gt; Clusters</strong>. You may need to refresh your web browser.</p>
</li>
<li>
<p>Click <strong>Create cluster</strong> to begin creating a GKE cluster.</p>
</li>
<li>
<p>Set the name of the cluster to <strong>standard-cluster-1</strong>, if that is not the default.</p>
</li>
<li>
<p>Confirm that a zonal, rather than regional, cluster is selected.</p>
</li>
<li>
<p>Choose zone <strong>us-central1-a</strong> for the cluster, if that is not the default.</p>
</li>
<li>
<p>In the <strong>default-pool</strong> section, set the <strong>Number of nodes</strong> to <strong>2</strong>.</p>
</li>
<li>
<p>Leave all other values at their defaults and click <strong>Create</strong>.</p>
</li>
</ol>
<ql-infobox><strong>Note:</strong> You need to wait a few minutes for the cluster deployment to complete.</ql-infobox>
<p>The cluster will successfully deploy this time.</p>
<h2 id="step4">Task 2. Create and Use Pod Security Policies</h2>
<p>When you enable pod security policy admission control on a cluster the default security policies configured by Kubernetes Engine prevent non-admin users running privileged pods. Users that are bound to the cluster-admin role are allowed to use the default policies that are installed when you enable Pod Security policies. You have to explicitly bind other users to roles that grant them the right to use specific policies, and this allows you to control what those users can and cannot deploy.</p>
<p>In this task you create a pod security policy that allows the creation of unprivileged Pods in the default namespace of the cluster. Unprivileged Pods do not allow users to execute code as root, and have limited access to devices on the host.</p>
<p>You create a ClusterRole that can then be used in a role binding that ties the policy to accounts that require the ability to deploy pods with unprivileged access.</p>
<p>Users that require the ability to deploy privileged Pods can be granted access to the built in PSP that is provided to allow admin users to deploy pods after Pod Security Policies are enabled.</p>
<p>When you have the components configured you will enable the PodSecurityPolicy controller, which enforces these policies, and then test how they impact users with different privileges.</p>
<h3>Connect to the GKE cluster</h3>
<ol>
<li>Switch back to the <strong>Username 1</strong> Google Cloud Console tab.</li>
</ol>
<aside class="warning"><p>Make sure you are on the <strong>Username 1</strong> Google Cloud Console tab.</p>
</aside>
<ol start="2">
<li>
<p>In Cloud Shell, type the following command to create environment variables for the Google Cloud zone and cluster name that were  used to create the cluster for this lab.</p>
</li>
</ol>
<pre><code>export my_zone=us-central1-a&#x000A;export my_cluster=standard-cluster-1&#x000A;</code></pre>
<ol start="3">
<li>
<p>Configure tab completion for the  kubectl command-line tool.</p>
</li>
</ol>
<pre><code>source &lt;(kubectl completion bash)&#x000A;</code></pre>
<ol start="4">
<li>
<p>Configure access to your cluster for kubectl:</p>
</li>
</ol>
<pre><code>gcloud container clusters get-credentials $my_cluster --zone $my_zone&#x000A;</code></pre>
<h3>Create a pod security policy</h3>
<p>You create a pod security policy using the  <code>restricted-psp.yaml</code> file that has been provided for you. This policy will only allow unprivileged Pods to be deployed and prevents privilege elevation using <strong>runAsUser</strong> with root account access.</p>
<p>This security policy can be used to provide users with accounts that are not bound to the Kubernetes cluster admin roles with the ability to deploy only unprivileged pods when the PodSecurityPolicy admission controller is enabled.</p>
<pre><code>apiVersion: policy/v1beta1&#x000A;kind: PodSecurityPolicy&#x000A;metadata:&#x000A;  name: restricted-psp&#x000A;spec:&#x000A;  privileged: false  # Don't allow privileged pods!&#x000A;  seLinux:&#x000A;    rule: RunAsAny&#x000A;  supplementalGroups:&#x000A;    rule: RunAsAny&#x000A;  runAsUser:&#x000A;    rule: MustRunAsNonRoot&#x000A;  fsGroup:&#x000A;    rule: RunAsAny&#x000A;  volumes:&#x000A;  - '*'&#x000A;</code></pre>
<ol>
<li>
<p>In Cloud Shell enter the following command  to clone the repository to the lab Cloud Shell.</p>
</li>
</ol>
<pre><code>git clone https://github.com/GoogleCloudPlatform/training-data-analyst&#x000A;</code></pre>
<ol start="2">
<li>
<p>Create a soft link as a shortcut to the working directory.</p>
</li>
</ol>
<pre><code>ln -s ~/training-data-analyst/courses/ak8s/v1.1 ~/ak8s&#x000A;</code></pre>
<ol start="3">
<li>
<p>Change to the directory that contains the sample files for this lab.</p>
</li>
</ol>
<pre><code>cd ~/ak8s/Security/&#x000A;</code></pre>
<ol start="4">
<li>
<p>To create the pod security policy, execute the following command:</p>
</li>
</ol>
<pre><code>kubectl apply -f restricted-psp.yaml&#x000A;</code></pre>
<p>This policy has no effect until a cluster role is created and bound to a user or service account with the permission to use the policy.</p>
<ol start="5">
<li>
<p>To confirm that the pod security policy has been created, execute the following command:</p>
</li>
</ol>
<pre><code>kubectl get podsecuritypolicy restricted-psp&#x000A;</code></pre>
<p>Click <em>Check my progress</em> to verify the objective.
<ql-activity-tracking step="3">
Create a pod security policy
</ql-activity-tracking></p>
<h3>Create a ClusterRole for a pod security policy</h3>
<p>The file <code>restricted-pods-role.yaml</code> creates a ClusterRole that includes the resource you created in the last task, <code>restricted-psp</code>, and grants the subject the ability to use the <code>restricted-psp</code> resource. The subject is the user or service account that is bound to this role. You will bind an account to this role later to enable the use of the policy.</p>
<p>The file <code>restricted-pods-role.yaml</code> has been provided for you.</p>
<pre><code>kind: ClusterRole&#x000A;apiVersion: rbac.authorization.k8s.io/v1&#x000A;metadata:&#x000A;  name: restricted-pods-role&#x000A;rules:&#x000A;- apiGroups:&#x000A;  - extensions&#x000A;  resources:&#x000A;  - podsecuritypolicies&#x000A;  resourceNames:&#x000A;  - restricted-psp&#x000A;  verbs:&#x000A;  - use&#x000A;</code></pre>
<p>However, before you can create a role, the account you use to create the role must already have the permissions granted in the role being assigned. For cluster administrators this can be easily accomplished by creating the necessary RoleBinding to grant your own user account the <code>cluster-admin</code> role.  The <strong>Username 1</strong> account has project owner rights and this automatically makes this user a cluster administrator.</p>
<ol>
<li>
<p>Create an environment variable to store the mail address of the <strong>Username 1</strong> account:</p>
</li>
</ol>
<pre><code class="language-bash prettyprint">export USERNAME_1_EMAIL=$(gcloud info --format='value(config.account)')&#x000A;</code></pre>
<ol start="2">
<li>
<p>To grant your user account cluster-admin privileges, run the following command:</p>
</li>
</ol>
<pre><code class="language-bash prettyprint">kubectl create clusterrolebinding cluster-admin-binding --clusterrole cluster-admin --user $USERNAME_1_EMAIL&#x000A;</code></pre>
<ol start="3">
<li>
<p>To create the ClusterRole with access to the security policy, execute the following command:</p>
</li>
</ol>
<pre><code>kubectl apply -f restricted-pods-role.yaml&#x000A;</code></pre>
<ol start="4">
<li>
<p>To confirm that the ClusterRole has been created, execute the following command:</p>
</li>
</ol>
<pre><code>kubectl get clusterrole restricted-pods-role&#x000A;</code></pre>
<p>The new ClusterRole is ready, but it is not yet bound to a subject, and therefore is not yet active. You will bind it to a subject in a later step.</p>
<p>Click <em>Check my progress</em> to verify the objective.
<ql-activity-tracking step="4">
Bind Username 1 to the cluster admin role and create the restricted-pods role
</ql-activity-tracking></p>
<h3>Activate Security Policy</h3>
<p>The PodSecurityPolicy controller must be enabled to affect the admission control of new Pods in the cluster.</p>
<aside class="warning"><p><strong>Caution! </strong></p>
<p>If you do not define and authorize policies prior to enabling the PodSecurityPolicy controller, some accounts will not be able to deploy or run Pods on the cluster.</p>
</aside>
<ol>
<li>
<p>In Cloud Shell, execute the following command to enable the PodSecurityPolicy controller:</p>
</li>
</ol>
<pre><code>gcloud beta container clusters update $my_cluster --zone $my_zone --enable-pod-security-policy&#x000A;</code></pre>
<p>This process takes several minutes to complete.</p>
<aside class="special"><p><strong>Note: </strong>The PodSecurityPolicy controller, can be disabled by running this command:</p>
<p><code>gcloud beta container clusters update [CLUSTER_NAME] --no-enable-pod-security-policy</code></p>
</aside>
<ol start="2">
<li>
<p>In Cloud Shell, execute the following command to check that the PodSecurityPolicy controller is active:</p>
</li>
</ol>
<pre><code class="language-bash prettyprint">kubectl get podsecuritypolicies&#x000A;</code></pre>
<p>When the PodSecurityPolicy controller is fully active you will see a number of policies starting with <code>gce.</code>. Repeat the command after a minute or two until you see more than one policy listed.</p>
<p>Note that one of the built in policies, <code>gce.privileged</code>, explicitly allows privileged pods to be deployed. By default, only accounts that are bound to the cluster-admin role have permission to use the <code>gce.privileged</code> policy.</p>
<p><strong>Sample output ( Do not copy)</strong></p>
<pre><code>NAME                           PRIV&#x000A;gce.event-exporter             false&#x000A;gce.fluentd-gcp                false&#x000A;gce.persistent-volume-binder   false&#x000A;gce.privileged                 true  &#x000A;gce.unprivileged-addon         false&#x000A;restricted-psp                 false&#x000A;</code></pre>
<ol start="3">
<li>
<p>To confirm that the <strong>Username 1</strong> account has access to the <code>gce.privileged</code> pod security policy run the following command:</p>
</li>
</ol>
<pre><code class="language-bash prettyprint">kubectl auth can-i use podsecuritypolicy/gce.privileged&#x000A;</code></pre>
<p>This will return <code>yes</code> indicating that <strong>Username 1</strong> will match with this policy and should be allowed to deploy privileged pods.</p>
<p>Click <em>Check my progress</em> to verify the objective.
<ql-activity-tracking step="5">
Enable Pod Security Policies
</ql-activity-tracking></p>
<h3>Test the pod security policy using the first user account</h3>
<p>You now test to see whether the pod security policies restrict <strong>Username 1</strong> who is a user bound to the cluster admin role. A sample Pod manifest called <code>privileged-pod.yaml</code> has been provided for you. This Pod attempts to start an nginx container in a privileged context.</p>
<pre><code>kind: Pod&#x000A;apiVersion: v1&#x000A;metadata:&#x000A;  name: privileged-pod&#x000A;spec:&#x000A;  containers:&#x000A;    - name: privileged-pod&#x000A;      image: nginx&#x000A;      securityContext:&#x000A;        privileged: true&#x000A;</code></pre>
<ol>
<li>
<p>To attempt to run the privileged Pod, execute the following command in the <strong>Username 1</strong> Cloud Shell:</p>
</li>
</ol>
<pre><code>kubectl apply -f privileged-pod.yaml&#x000A;</code></pre>
<p>This will succeed because <strong>Username 1</strong> has been assigned the cluster admin role and that role is allowed to use the <code>gce.privileged</code> pod security policy that is enabled by default.</p>
<ol start="2">
<li>
<p>Execute the following command in the <strong>Username 1</strong> Cloud Shell to delete the privileged Pod.</p>
</li>
</ol>
<pre><code>kubectl delete pod privileged-pod&#x000A;</code></pre>
<p>You will try to redeploy the privileged Pod later using the  <strong>Username 2</strong> account in the next section to test how the pod security policy affects a user who is not bound to the Kubernetes cluster admin role.</p>
<h3>Test the pod security policy using the second user account</h3>
<p>The final step in the process involves testing to see if the policy is active. You have to configure the Cloud Shell for <strong>Username 2</strong> before you can attempt to deploy the test Pods for this task from the Cloud Shell. A second sample Pod manifest called <code>unprivileged-pod.yaml</code> has been provided for you. This Pod attempts to start an unprivileged nginx container.</p>
<pre><code>kind: Pod&#x000A;apiVersion: v1&#x000A;metadata:&#x000A;  name: unprivileged-pod&#x000A;spec:&#x000A;  containers:&#x000A;    - name: unprivileged-pod&#x000A;      image: nginx&#x000A;</code></pre>
<ol>
<li>Switch back to the <strong>Username 2</strong> Google Cloud Console tab.</li>
</ol>
<aside class="warning"><p>Make sure you are on the <strong>Username 2</strong> Google Cloud Console tab.</p>
</aside>
<ol start="2">
<li>On the Google Cloud Console title bar, click <strong>Activate Cloud Shell (</strong> <img alt="e92fcd01cbb5e0ff.png" src="https://cdn.qwiklabs.com/G2OU7QatKvkGgxCZRcv3IFJd8GvwHIJz6JhAtOMT5cg%3D"><strong>)</strong>.</li>
<li>When prompted, click <strong>Continue</strong>.</li>
</ol>
<p>After a moment of provisioning, the Cloud Shell prompt appears.</p>
<ol start="4">
<li>
<p>In Cloud Shell, type the following command to create environment variables for the Google Cloud zone and cluster name that were  used to create the cluster for this lab.</p>
</li>
</ol>
<pre><code>export my_zone=us-central1-a&#x000A;export my_cluster=standard-cluster-1&#x000A;</code></pre>
<ol start="5">
<li>
<p>Configure tab completion for the  kubectl command-line tool.</p>
</li>
</ol>
<pre><code>source &lt;(kubectl completion bash)&#x000A;</code></pre>
<ol start="6">
<li>
<p>Configure access to your cluster for kubectl:</p>
</li>
</ol>
<pre><code>gcloud container clusters get-credentials $my_cluster --zone $my_zone&#x000A;</code></pre>
<ol start="7">
<li>
<p>In Cloud Shell enter the following command to clone the repository to the lab Cloud Shell for the second user.</p>
</li>
</ol>
<pre><code>git clone https://github.com/GoogleCloudPlatform/training-data-analyst&#x000A;</code></pre>
<ol start="8">
<li>
<p>Create a soft link as a shortcut to the working directory.</p>
</li>
</ol>
<pre><code>ln -s ~/training-data-analyst/courses/ak8s/v1.1 ~/ak8s&#x000A;</code></pre>
<ol start="9">
<li>
<p>Change to the directory that contains the sample files for this lab.</p>
</li>
</ol>
<pre><code>cd ~/ak8s/Security/&#x000A;</code></pre>
<ol start="10">
<li>
<p>To attempt to run the unprivileged Pod, execute the following command:</p>
</li>
</ol>
<pre><code>kubectl apply -f unprivileged-pod.yaml&#x000A;</code></pre>
<p>You should not be able to deploy the unprivileged Pod because the <strong>Username 2</strong> account has not yet been bound to any role that allows pods to be deployed.</p>
<p><strong>Output (Do not copy):</strong></p>
<pre><code class="language-bash prettyprint">Error from server (Forbidden): error when creating "unprivileged-pod.yaml": pods "unprivileged-pod" is forbidden: unable to validate against any pod security policy: []&#x000A;</code></pre>
<ol start="11">
<li>
<p>To attempt to run the privileged Pod, execute the following command:</p>
</li>
</ol>
<pre><code>kubectl apply -f privileged-pod.yaml&#x000A;</code></pre>
<p>You should also not be able to deploy the privileged Pod because the <strong>Username 2</strong> account has not yet been bound to any role that allows privileged pods to be deployed.</p>
<p><strong>Output (Do not copy):</strong></p>
<pre><code class="language-bash prettyprint">Error from server (Forbidden): error when creating "privileged-pod.yaml": pods "privileged-pod" is forbidden: unable to validate against any pod security policy: []&#x000A;</code></pre>
<ol start="12">
<li>
<p>Run the following command to check whether the second user has access to the restricted-psp PSP that would allow the unprivileged pod to be created:</p>
</li>
</ol>
<pre><code class="language-bash prettyprint">kubectl auth can-i use podsecuritypolicy/restricted-psp&#x000A;</code></pre>
<p>This will report that username 2 does not have permission to use this policy. Since there is no other policy active that could allow restricted pods to be deployed the second user cannot deploy any restricted pods.</p>
<ol start="13">
<li>
<p>Run the following command to check whether the second user has access to the <code>gce.privileged</code> PSP that allows cluster admins to deploy privileged pods.</p>
</li>
</ol>
<pre><code class="language-bash prettyprint">kubectl auth can-i use podsecuritypolicy/gce.privileged&#x000A;</code></pre>
<p>This will report that username 2 does not have permission to use this policy either.</p>
<p>In order to be able to deploy unprivileged pods you must bind <strong>Username 2</strong> to the <code>restricted-pods-role</code> role that provides access to the <code>restricted-psp</code> pod security policy.</p>
<ol start="14">
<li>
<p>Switch back to the <strong>Username 1</strong> console.</p>
</li>
<li>
<p>Enter the following command, to bind <strong>Username 2</strong> to the <code>restricted-pods</code> role replacing <code>[USERNAME_2_EMAIL]</code> with the email address of the <strong>Username 2</strong> account:</p>
</li>
</ol>
<pre><code class="language-bash prettyprint">kubectl create clusterrolebinding restricted-pods-binding --clusterrole restricted-pods-role --user [USERNAME_2_EMAIL]&#x000A;</code></pre>
<ol start="16">
<li>
<p>Switch back to the <strong>Username 2</strong> Cloud Shell and attempt to deploy the unprivileged Pod again.</p>
</li>
</ol>
<pre><code>kubectl apply -f unprivileged-pod.yaml&#x000A;</code></pre>
<p>The command now succeeds because <strong>Username 2</strong> now has permission to use the restricted-pods pod security policy.</p>
<ol start="17">
<li>
<p>To confirm that <strong>Username 2</strong> still does not have access to the unrestricted-pods PSP enter the following command in the Cloud Shell for <strong>Username 2</strong>.</p>
</li>
</ol>
<pre><code>kubectl apply -f privileged-pod.yaml&#x000A;</code></pre>
<p>This command will still fail because <strong>Username 2</strong> still does not have access to the any PSP that allows users to deploy privileged pods.</p>
<ol start="18">
<li>
<p>Switch back to <strong>Username 1</strong> Cloud Shell and enter the same command to demonstrate that an account with access to a suitable PSP can deploy privileged pods.</p>
</li>
</ol>
<pre><code>kubectl apply -f privileged-pod.yaml&#x000A;</code></pre>
<p>This command will succeed because <strong>Username 1</strong> has access to the <code>gce.privileged</code> PSP.</p>
<h2 id="step5">Task 3. Rotate IP Address and Credentials</h2>
<p>You perform IP and credential rotation on your cluster. It is a secure practice to do so regularly to reduce credential lifetimes. While there are separate commands to rotate the serving IP and credentials, rotating credentials additionally rotates the IP as well.</p>
<ol>
<li>
<p>In Cloud Shell, execute the following command:</p>
</li>
</ol>
<pre><code>gcloud container clusters update $my_cluster --zone $my_zone --start-credential-rotation&#x000A;</code></pre>
<ol start="2">
<li>Enter <code>Y</code> to continue.</li>
<li>Leave the Cloud Shell open until the operation is complete.</li>
</ol>
<p>After the command completes in the Cloud Shell in this lab the cluster will probably initiate the process to upgrade all of the nodes. Performing a credential rotation causes GKE to upgrade all node pools to the closest supported node version. For more information, refer to <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/upgrading-a-cluster" target="_blank">Upgrading a Container Cluster</a>.</p>
<ql-infobox><strong>Note:</strong> You need to wait for about up to 15 minutes for your cluster.</ql-infobox>
<p>If you are monitoring this in the Google Cloud Console you may need to refresh the page to see the node upgrade progress notifications.</p>
<p><img alt="node_upgrade.png" src="https://cdn.qwiklabs.com/YLdMiGLy%2BjxcfuCN11cuW%2BntEsYZ77ApFzUEI%2BO94gQ%3D"></p>
<ol start="4">
<li>
<p>To view the active operations on the cluster execute the following command:</p>
</li>
</ol>
<pre><code>gcloud container operations list&#x000A;</code></pre>
<p>You will see that there is a running process of type <code>UPGRADE_NODES</code>.</p>
<ql-infobox><strong>Note:</strong> This can take upto 10 minutes to begin.

<p>If after 15 minutes  you can not see a process type of `UPGRADE_NODES`, you need to run the following command</p>
<p><code>gcloud container clusters upgrade $my_cluster --zone $my_zone --node-pool=default-pool</code></p>
<p>This will force the nodes to start the upgrade process.  This step is to avoid unnecessary waiting times in this lab.</p>
</ql-infobox>
<ol start="5">
<li>
<p>To save the operations task ID for the node upgrade operation to an environment variable execute the following command:</p>
</li>
</ol>
<pre><code>export UPGRADE_ID=$(gcloud container operations list --filter="operationType=UPGRADE_NODES and status=RUNNING" --format='value(name)')&#x000A;</code></pre>
<ol start="6">
<li>To monitor the status of the node upgrade operation execute the following command:</li>
</ol>
<pre><code>gcloud container operations wait $UPGRADE_ID --zone=$my_zone&#x000A;</code></pre>
<p>This command will report the node upgrade process until all nodes have been upgraded. When the operation has finished you will see output similar to the following:</p>
<p><strong>Sample output ( Do not copy)</strong></p>
<pre><code>Waiting for operation-1567076865370-fd0f5914 to complete...done.&#x000A;endTime: '2019-08-29T11:22:10.190373855Z'&#x000A;name: operation-1567076865370-fd0f5914&#x000A;operationType: UPGRADE_NODES&#x000A;selfLink: https...&#x000A;startTime: '2019-08-29T11:07:45.370167092Z'&#x000A;status: DONE&#x000A;targetLink: https...&#x000A;zone: us-central1-a&#x000A;</code></pre>
<aside class="special"><p><strong>Note: </strong>These processes automatically update the kubeconfig entry for the current user. You must update the kubeconfig file on any other system that uses kubectl or API to access the master before completing the rotation process to avoid losing access. </p>
</aside>
<p>The cluster master now temporarily serves the new IP address in addition to the original address. If you initiate a credential rotation, but do not complete it, GKE automatically completes the rotation after seven days.</p>
<ol start="7">
<li>
<p>To complete the credential and IP rotation tasks execute the following command:</p>
</li>
</ol>
<pre><code>gcloud container clusters update $my_cluster --zone $my_zone --complete-credential-rotation&#x000A;</code></pre>
<p>Enter <code>Y</code> to continue.</p>
<p>This finalizes the rotation processes and removes the original cluster ip-address.</p>
<p>Click <em>Check my progress</em> to verify the objective.
<ql-activity-tracking step="6">
Rotate IP Address and Credentials
</ql-activity-tracking></p>
<h2 id="step6">End your lab</h2>
<p>When you have completed your lab, click <strong>End Lab</strong>. Qwiklabs removes the resources you’ve used and cleans the account for you.</p>
<p>You will be given an opportunity to rate the lab experience. Select the applicable number of stars, type a comment, and then click <strong>Submit</strong>.</p>
<p>The number of stars indicates the following:</p>
<ul>
<li>1 star = Very dissatisfied</li>
<li>2 stars = Dissatisfied</li>
<li>3 stars = Neutral</li>
<li>4 stars = Satisfied</li>
<li>5 stars = Very satisfied</li>
</ul>
<p>You can close the dialog box if you don't want to provide feedback.</p>
<p>For feedback, suggestions, or corrections, please use the <strong>Support</strong> tab.</p>

<p>Copyright 2021 Google LLC All rights reserved. Google and the Google logo are trademarks of Google LLC. All other company and product names may be trademarks of the respective companies with which they are associated.</p>



</div>
</div>


<div class='hidden js-end-lab-button-container lab-content__end-lab-button'>
<ql-lab-control-button class='js-end-lab-button' running></ql-lab-control-button>
</div>
<!-- / TODO: Move recommendations into the end lab modal -->
</ql-drawer-content>
<ql-drawer end id='outline-drawer' open slot='drawer' width='320'>
<div class='js-lab-content-outline lab-content__outline'>
<a href='#step1'>Overview</a><a href='#step2'>Objectives</a><a href='#step3'>Task 1: Use Cloud IAM roles to grant administrative access to all the GKE clusters in the project</a><a href='#step4'>Task 2. Create and Use Pod Security Policies</a><a href='#step5'>Task 3. Rotate IP Address and Credentials</a><a href='#step6'>End your lab</a>
</div>
</ql-drawer>
</ql-drawer-container>
</ql-drawer-content>
</ql-drawer-container>
<div class='lab-introduction js-lab-introduction is-hidden'>
<div class='lab-introduction__inner'>
<h1 class='headline-1'>Welcome to Your First Lab!</h1>
<ql-icon-button class='js-skip-button'>close</ql-icon-button>
<div class='lab-introduction__video'>
<iframe allow='autoplay; encrypted-media' allowfullscreen frameborder='0' id='lab-introduction' src='https://www.youtube.com/embed/yF7EDXKTmoQ?enablejsapi=1&amp;rel=0&amp;showinfo=0'></iframe>
</div>
<a class='js-skip-button button button--outline'>Skip this video</a>
</div>
</div>



</div>
</main>


<div class='modal fade' id='lab-details-modal'>
<div class='modal-container'>
<div class='mdl-shadow--24dp modal-content'>
<div class='modal-body'>
<p class='l-mbm'>
Architecting with Google Kubernetes Engine: Securing Kubernetes Engine with Cloud IAM and Pod Security Policies
</p>
<p class='small-label l-mbs'>
<strong>
Duration:
</strong>
0m setup
&middot;
90m access
&middot;
90m completion
</p>
<p class='small-label l-mbs'>
<span><strong>Levels: </strong>fundamental</span>
</p>
<p class='small-label'>
<strong>
Permalink:
</strong>
<a href="https://googlecoursera.qwiklabs.com/catalog_lab/2305">https://googlecoursera.qwiklabs.com/catalog_lab/2305</a>
</p>
</div>
<div class='modal-actions'>
<a class='button button--text' data-dismiss='modal'>
Got It
</a>
</div>


</div>
</div>
<iframe class='l-ie-iframe-fix'></iframe>
</div>
<div class='modal fade' id='lab-review-modal'>
<div class='modal-container'>
<div class='mdl-shadow--24dp modal-content'>
<form class="simple_form js-lab-review-form" id="edit_lab_review_12003559" action="/lab_reviews/12003559" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="_method" value="patch" /><div class='modal-body'>
<p class='label'>
How satisfied are you with this lab?*
</p>
<div class='rateit js-rateit' data-rateit-max='5' data-rateit-min='0' data-rateit-resetable='false' data-rateit-step='1' data-rateit-value='3'></div>
<div class='l-mtm'>

<div class="control-group hidden lab_review_user_id"><div class="controls"><input class="hidden" type="hidden" value="3894861" name="lab_review[user_id]" id="lab_review_user_id" /></div></div>
<div class="control-group hidden lab_review_classroom_id"><div class="controls"><input class="hidden" type="hidden" name="lab_review[classroom_id]" id="lab_review_classroom_id" /></div></div>
<div class="control-group hidden lab_review_lab_id"><div class="controls"><input class="hidden" type="hidden" value="2305" name="lab_review[lab_id]" id="lab_review_lab_id" /></div></div>
<div class="control-group hidden lab_review_focus_id"><div class="controls"><input class="hidden" type="hidden" name="lab_review[focus_id]" id="lab_review_focus_id" /></div></div>
<div class="control-group hidden lab_review_rating"><div class="controls"><input class="hidden js-rating-input" type="hidden" value="0" name="lab_review[rating]" id="lab_review_rating" /></div></div>
<div class="control-group text optional lab_review_comment"><label class="text optional control-label" for="lab_review_comment">Comment</label><div class="controls"><textarea class="text optional" name="lab_review[comment]" id="lab_review_comment">
</textarea></div></div>
</div>
</div>
<div class='modal-actions'>
<a class='button button--text' data-dismiss='modal'>
Cancel
</a>
<input type="submit" name="commit" value="Submit" disabled="disabled" id="submit" data-disabled="false" class="button" data-disable-with="Submit" />
</div>
</form>

</div>
</div>
<iframe class='l-ie-iframe-fix'></iframe>
</div>


<script>
  $( function() {
    ql.initMaterialInputs();
    initChosen();
    initSearch();
    initTabs();
    ql.list.init();
    ql.favoriting.init();
    ql.header.myAccount.init();
    initTooltips();
    ql.autocomplete.init();
    ql.modals.init();
    ql.toggleButtons.init();
    ql.analytics.init();
    ql.labControlPanel.addRecaptchaErrorHandler();
  initLabContent();
  ql.labOutline.links.init();
  initLabReviewModal();
  ql.labAssessment.init();
  ql.labIntroduction.init( true );
  ql.labData.init();
  initLabTranslations( {"are_you_sure":"All done? If you end this lab, you will lose all your work. You may not be able to restart the lab if there is a quota limit. Are you sure you want to end this lab?\n","in_progress":"*In Progress*","ending":"*Ending*","starting":"*Starting, please wait*","end_concurrent_labs":"Sorry, you can only run one lab at a time. To start this lab, please confirm that you want all of your existing labs to end.\n","copied":"Copied","no_resource":"Error retrieving resource.","no_support":"No Support","mac_press":"Press ⌘-C to copy","thanks_review":"Thanks for reviewing this lab.","windows_press":"Press Ctrl-C to copy","days":"days"} );
  ql.labRun.init();
  ql.chat.init();
  ql.initHeader();
  ql.navigation.init();
  ql.navPanel.init();
  ql.navigation.init();
  
  });
</script>

</body>
</html>

